# CGAS

## Release Note：

**1.0.3**

Script Hash: [0x74f2dc36a68fdc4682034178eb2220729231db76](https://neotracker.io/contract/74f2dc36a68fdc4682034178eb2220729231db76)

CGAS Contract Address: AScKxyXmNtEnTLTvbVhNQyTJmgytxhwSnM

Known Issues: not found

**1.0.2**

Script Hash: [0x505663a29d83663a838eee091249abd167e928f5](https://neotracker.io/contract/505663a29d83663a838eee091249abd167e928f5)

CGAS Contract Address: Ae8AD6Rc3cvQapqttJcUTj9ULfLi2tLHmc

Known Issues: `transfer` method cannot be called by other contract

**1.0.1**

Script Hash: [0x9121e89e8a0849857262d67c8408601b5e8e0524](https://neotracker.io/contract/9121e89e8a0849857262d67c8408601b5e8e0524)

CGAS Contract Address: AK4LdT5ZXR9DQZjfk5X6Xy79mE8ad8jKAW

Known Issues: `transferAPP` method naming not canonical



It is recommended to use the latest version, if you have already used the old version, do not worry, you can refund CGAS to GAS and transfer GAS to the latest version contract. the old version contract will not cause asset loss.

## Readme

[English](#en) [简体中文](#zh)

<a name="en"></a>

### Overview:

CGAS refer to NEP-5 contract assets issued by NGD (NEO Global Development). CGAS can be exchanged for GAS at a 1:1 ratio and are fully refundable. The contract aims to map global assets GAS for the benefit of its internal transfer using the method of contract invocation.

### Descriptions:

Methods defined in NEP-5 standard:

| Methods     | Parameters                         | Return value | Descriptions                                                 |
| ----------- | ---------------------------------- | ------------ | ------------------------------------------------------------ |
| balanceOf   | byte[] account                     | int          | Get the CGAS balance of an account. The return value is the actual amount x 10⁸. |
| decimals    | ---                                | int          | Get the decimals of CGAS. The return value is constant `8`.  |
| name        | ---                                | string       | Get the contract name. The return value is constant `NEP5 GAS`. |
| symbol      | ---                                | string       | Get the contract symbol. The return value is constant `CGAS`. |
| totalSupply | ---                                | int          | Get the total supply of CGAS. The return value is the actual amount × 10⁸. Given that CGAS is exchanged for GAS at a 1:1 ratio, the GAS amount retrieved from the contract address is equal to the total supply of CGAS. |
| transfer    | byte[] from, byte[] to, int amount | bool         | A transfer method that transfers CGAS from the sender account to the recipient account. The transfer value is the "amount"; "from" and "to" are script hash value and "amount" is the actual transfer amount × 10⁸. This method supports both user invocation and contract invocation. |

Additional methods other than NEP-5 methods used to support GAS-CGAS swap:

| Methods            | Parameters  | Return value                                | Descriptions                                                 |
| ------------------ | ----------- | ------------------------------------------- | ------------------------------------------------------------ |
| getRefundTarget    | byte[] txId | byte[]                                      | Get the owner of the UTXO pending refund; the parameter is the TxId of the UTXO (confirm that a UTXO consists of TxId and output index; the output index takes the default value of 0); the return value is the account the UTXO is refunded to, whose owner can set the UTXO as a transaction input and send GAS from the CGAS address to his/her account. |
| getTxInfo          | byte[] txId | [TransferInfo](NeoContract/TransferInfo.cs) | Get detailed transfer info under a TxId. TxInfo will be recorded under the following 4 instructions: mintTokens, refund, transfer, transferAPP. |
| mintTokens         | ---         | bool                                        | A mintTokens method for CGAS users, who can transfer GAS to CGAS contract address by constructing InvocationTransaction and convert GAS to CGAS by invoking mintTokens method. Upon successful  invocation, CGAS in the equal value of the GAS will be added to the user's asset account. [NOTE](#note-en) |
| refund             | byte[] from | bool                                        | It takes two steps to claim CGAS and convert it to GAS. First, construct an InvocationTransaction, including GAS transfer within the same CGAS address (the transfer amount should be the GAS amount users expect to get refunded) to invoke the refund method (set the parameter as the Script Hash of the refund account). Upon successful invocation, CGAS in the equal amount of the refunded GAS will be automatically destroyed and the No.0 output of the transaction will be marked with the ownership of the user. Second, the user may construct a transaction and set the UTXO marked in the first step as a transaction input and his/her account as the transaction output to get GAS from the CGAS address. |
| supportedStandards | ---         | string                                      | NEP-10 standard for return contract; the return value is constant ：`{ "NEP-5", "NEP-7", "NEP-10" }` |

Notification defined in NEP-5 standard:

| Notification | Parameters                        | Descriptions                                                 |
| ------------ | --------------------------------- | ------------------------------------------------------------ |
| transfer     | byte[] from, byte[] to, int value | Notification contains the three elements of transfer: sender (from), recipient (to) and transfer value (value). CGAS is the default type of assets for transfer. |

Other notifications realized in the contract:



| Notification | Parameters              | Descriptions                                                 |
| ------------ | ----------------------- | ------------------------------------------------------------ |
| refund       | byte[] txid, byte[] who | Notification contains two elements of transfer: UTXO pending refund (txid) and Script Hash of refund account (who). |

<a name="note-en"></a>

> [NOTE]
>
> In mintTokens, please note that the total count of InvocationTransaction Inputs and Outputs should not be more than 60, otherwise the cost of execution will exceed the free limit of 10 GAS. If a large number of GAS UTXO need to be exchange to CGAS, it is recommended to make a regular transfer, UTXO merge, and then Minttokens operation.

### Examples

The following are the trading structures of `mintTokens` and `refund` and the application Log for developers' reference.

mintTokens transaction:

> [NOTE]
>
> Type: InvocationTransaction
>
> Input: from user's address
>
> Output: to CGAS contract address
>
> Script: invoke mintTokens methods in CGAS contract

```json
{
    "jsonrpc": "2.0",
    "id": 1,
    "result": {
        "txid": "0x48bd784d0ed6000cba64d0e303117e4c10081e3268afcf3b07e8b353a7594772",
        "size": 246,
        "type": "InvocationTransaction",
        "version": 1,
        "attributes": [],
        "vin": [
            {
                "txid": "0x5918258bb67ee292358f8780d6b86e8fcd825bdde623429e4e547a2f9e496cf8",
                "vout": 0
            }
        ],
        "vout": [
            {
                "n": 0,
                "asset": "0x602c79718b16e442de58778e148d0b1084e3b2dffd5de6b7b16cee7969282de7",
                "value": "10",
                "address": "AScKxyXmNtEnTLTvbVhNQyTJmgytxhwSnM"
            }
        ],
        "sys_fee": "0",
        "net_fee": "0",
        "scripts": [
            {
                "invocation": "408e13fc267d69ca1c8463ac8bc3f266343ee0661ef85e9fa66fe986dc787f14fc6c13279bc90883297e186ca65d918ccdcf407497c0de1de9573e9a519a4f9aa5",
                "verification": "21037ebe29fff57d8c177870e9d9eecb046b27fc290ccbac88a0e3da8bac5daa630dac"
            }
        ],
        "script": "000a6d696e74546f6b656e736776db3192722022eb7841038246dc8fa636dcf274f16658600e9b9af88bcb",
        "gas": "0",
        "blockhash": "0xafb5b19021e1b57e7d64deb9d99bedabb0e40fdc3393d6c58c324730c0061aae",
        "confirmations": 2,
        "blocktime": 1536906512
    }
}
```

mintTokens application log:

```json
{
	"txid": "0x48bd784d0ed6000cba64d0e303117e4c10081e3268afcf3b07e8b353a7594772",
	"vmstate": "HALT, BREAK",
	"gas_consumed": "4.648",
	"stack": [],
	"notifications": [{
		"contract": "0x74f2dc36a68fdc4682034178eb2220729231db76",
		"state": {
			"type": "Array",
			"value": [{
				"type": "ByteArray",
				"value": "7472616e73666572"
			}, {
				"type": "ByteArray",
				"value": ""
			}, {
				"type": "ByteArray",
				"value": "e8e3ce08268d16d867101feaf8c0ea130a923aba"
			}, {
				"type": "Integer",
				"value": "1000000000"
			}]
		}
	}]
}
```

refund 1st step transaction:

> [NOTE]
>
> Type: InvocationTransaction
>
> Input: from CGAS contract address
>
> Output: to CGAS contract address (same address to input)
>
> Script: invoke refund methods in CGAS contract, and  set the parameter as the Script Hash of the refund account
>
> Scripts: need 2 witnesses: 1、witness of CGAS; 2、witness of user (additional witness)

```json
{
    "jsonrpc": "2.0",
    "id": 1,
    "result": {
        "txid": "0x306daa4ab2b2ef73ff4fd8f9121fc926f5e21653080602b6841ad3f17f80777c",
        "size": 7205,
        "type": "InvocationTransaction",
        "version": 0,
        "attributes": [
            {
                "usage": "Script",
                "data": "e8e3ce08268d16d867101feaf8c0ea130a923aba"
            }
        ],
        "vin": [
            {
                "txid": "0x48bd784d0ed6000cba64d0e303117e4c10081e3268afcf3b07e8b353a7594772",
                "vout": 0
            }
        ],
        "vout": [
            {
                "n": 0,
                "asset": "0x602c79718b16e442de58778e148d0b1084e3b2dffd5de6b7b16cee7969282de7",
                "value": "5",
                "address": "AScKxyXmNtEnTLTvbVhNQyTJmgytxhwSnM"
            },
            {
                "n": 1,
                "asset": "0x602c79718b16e442de58778e148d0b1084e3b2dffd5de6b7b16cee7969282de7",
                "value": "5",
                "address": "AScKxyXmNtEnTLTvbVhNQyTJmgytxhwSnM"
            }
        ],
        "sys_fee": "0",
        "net_fee": "0",
        "scripts": [
            {
                "invocation": "520131",
                "verification": "012fc56b6c766b00527ac46c766b51527ac4616168164e656f2e52756e74696d652e47657454726967676572009c6c766b52527ac46c766b52c36418046161682953797374656d2e457865637574696f6e456e67696e652e476574536372697074436f6e7461696e65726c766b53527ac46c766b53c36168194e656f2e5472616e73616374696f6e2e476574496e707574736c766b54527ac46c766b53c361681a4e656f2e5472616e73616374696f6e2e4765744f7574707574736c766b55527ac4616c766b54c36c766b59527ac4006c766b5a527ac4622b016c766b59c36c766b5ac3c36c766b5b527ac4616c766b5bc36168124e656f2e496e7075742e476574496e646578009c6c766b5c527ac46c766b5cc364de00616168164e656f2e53746f726167652e476574436f6e7465787406726566756e64617c6545176c766b5d527ac46c766b5dc36c766b5bc36168114e656f2e496e7075742e47657448617368617c6555176c766b5e527ac46c766b5ec3c000a06c766b5f527ac46c766b5fc3646f00616c766b54c3c051907c907c9e6310006c766b55c3c0519c009c620400516c766b60527ac46c766b60c3640f00006c766b0111527ac4620f076c766b55c300c36168184e656f2e4f75747075742e476574536372697074486173686c766b5ec39c6c766b0111527ac462dc0661616c766b5ac351936c766b5a527ac46c766b5ac36c766b59c3c09f63ccfe61682d53797374656d2e457865637574696f6e456e67696e652e476574457865637574696e67536372697074486173686c766b56527ac4006c766b57527ac4616c766b53c361681d4e656f2e5472616e73616374696f6e2e4765745265666572656e6365736c766b0112527ac4006c766b0113527ac462e9006c766b0112c36c766b0113c3c36c766b0114527ac4616c766b0114c36168154e656f2e4f75747075742e476574417373657449646120e72d286979ee6cb1b7e65dfddfb2e384100b8d148e7758de42e4168b71792c609e6c766b0115527ac46c766b0115c3640f00006c766b0111527ac462d0056c766b0114c36168184e656f2e4f75747075742e476574536372697074486173686c766b56c39c6c766b0116527ac46c766b0116c3642c006c766b57c36c766b0114c36168134e656f2e4f75747075742e47657456616c7565936c766b57527ac4616c766b0113c351936c766b0113527ac46c766b0113c36c766b0112c3c09f630cff006c766b58527ac4616c766b55c36c766b0117527ac4006c766b0118527ac4628b006c766b0117c36c766b0118c3c36c766b0119527ac4616c766b0119c36168184e656f2e4f75747075742e476574536372697074486173686c766b56c39c6c766b011a527ac46c766b011ac3642c006c766b58c36c766b0119c36168134e656f2e4f75747075742e47657456616c7565936c766b58527ac4616c766b0118c351936c766b0118527ac46c766b0118c36c766b0117c3c09f636aff6c766b58c36c766b57c39c6c766b0111527ac4627c046168164e656f2e52756e74696d652e47657454726967676572609c6c766b011b527ac46c766b011bc3649e026161682b53797374656d2e457865637574696f6e456e67696e652e47657443616c6c696e67536372697074486173686c766b011c527ac46c766b00c30962616c616e63654f66876c766b011d527ac46c766b011dc36419006c766b51c300c36165f7036c766b0111527ac462e2036c766b00c308646563696d616c73876c766b011e527ac46c766b011ec3641200616570046c766b0111527ac462b3036c766b00c30f676574526566756e64546172676574876c766b011f527ac46c766b011fc36419006c766b51c300c361653b046c766b0111527ac46276036c766b00c3096765745478496e666f876c766b0120527ac46c766b0120c36419006c766b51c300c36165b1046c766b0111527ac4623f036c766b00c30a6d696e74546f6b656e73876c766b0121527ac46c766b0121c36412006165e6056c766b0111527ac4620e036c766b00c3046e616d65876c766b0122527ac46c766b0122c36412006165200a6c766b0111527ac462e3026c766b00c306726566756e64876c766b0123527ac46c766b0123c36419006c766b51c300c36165fc096c766b0111527ac462af026c766b00c30673796d626f6c876c766b0124527ac46c766b0124c36412006165f70e6c766b0111527ac46282026c766b00c312737570706f727465645374616e6461726473876c766b0125527ac46c766b0125c36412006165ca0e6c766b0111527ac46249026c766b00c30b746f74616c537570706c79876c766b0126527ac46c766b0126c36412006165bc0e6c766b0111527ac46217026c766b00c3087472616e73666572876c766b0127527ac46c766b0127c36441006c766b51c300c36c766b51c351c36c766b51c352c36c766b011cc361537951795572755172755279527954727552727565d60e6c766b0111527ac462b9016162a9016168164e656f2e52756e74696d652e47657454726967676572519c6c766b0128527ac46c766b0128c3647d016161682d53797374656d2e457865637574696f6e456e67696e652e476574457865637574696e67536372697074486173686c766b0129527ac461682953797374656d2e457865637574696f6e456e67696e652e476574536372697074436f6e7461696e65726c766b012a527ac4616c766b012ac361681a4e656f2e5472616e73616374696f6e2e4765744f7574707574736c766b012b527ac4006c766b012c527ac462bb006c766b012bc36c766b012cc3c36c766b012d527ac4616c766b012dc36168184e656f2e4f75747075742e476574536372697074486173686c766b0129c3907c907c9e6347006c766b012dc36168154e656f2e4f75747075742e476574417373657449646120e72d286979ee6cb1b7e65dfddfb2e384100b8d148e7758de42e4168b71792c609e620400006c766b012e527ac46c766b012ec3640f00006c766b0111527ac4623d00616c766b012cc351936c766b012c527ac46c766b012cc36c766b012bc3c09f633aff516c766b0111527ac4620f00006c766b0111527ac46203006c766b0111c3616c756654c56b6c766b00527ac4616c766b00c3c001149c009c6c766b52527ac46c766b52c36439003254686520706172616d65746572206163636f756e742053484f554c442062652032302d62797465206164647265737365732e6175f06168164e656f2e53746f726167652e476574436f6e74657874056173736574617c652f0f6c766b51527ac46c766b51c36c766b00c3617c65530f6c766b53527ac46203006c766b53c3616c756600c56b58616c756654c56b6c766b00527ac4616c766b00c3c001209c009c6c766b52527ac46c766b52c3643d003654686520706172616d6574657220747849642053484f554c442062652033322d62797465207472616e73616374696f6e20686173682e6175f06168164e656f2e53746f726167652e476574436f6e7465787406726566756e64617c657a0e6c766b51527ac46c766b51c36c766b00c3617c659e0e6c766b53527ac46203006c766b53c3616c756656c56b6c766b00527ac4616c766b00c3c001209c009c6c766b53527ac46c766b53c3643d003654686520706172616d6574657220747849642053484f554c442062652033322d62797465207472616e73616374696f6e20686173682e6175f06168164e656f2e53746f726167652e476574436f6e74657874067478496e666f617c65cd0d6c766b51527ac46c766b51c36c766b00c3617c65f10d6c766b52527ac46c766b52c3c0009c6c766b54527ac46c766b54c3640e00006c766b55527ac4622c006c766b52c36168174e656f2e52756e74696d652e446573657269616c697a656c766b55527ac46203006c766b55c3616c756653c56b6c766b00527ac4616c766b00c361681a4e656f2e426c6f636b636861696e2e476574436f6e74726163746c766b51527ac46c766b51c36424006c766b51c36168164e656f2e436f6e74726163742e497350617961626c65620400516c766b52527ac46203006c766b52c3616c75660114c56b6161682953797374656d2e457865637574696f6e456e67696e652e476574536372697074436f6e7461696e65726c766b00527ac4006c766b51527ac46c766b00c361681d4e656f2e5472616e73616374696f6e2e4765745265666572656e6365736c766b52527ac4616c766b52c36c766b59527ac4006c766b5a527ac46210016c766b59c36c766b5ac3c36c766b5b527ac4616c766b5bc36168154e656f2e4f75747075742e476574417373657449646120e72d286979ee6cb1b7e65dfddfb2e384100b8d148e7758de42e4168b71792c609c6c766b5c527ac46c766b5cc36434006c766b51c376632400756c766b5bc36168184e656f2e4f75747075742e476574536372697074486173686c766b51527ac46c766b5bc36168184e656f2e4f75747075742e4765745363726970744861736861682d53797374656d2e457865637574696f6e456e67696e652e476574457865637574696e67536372697074486173689c6c766b5d527ac46c766b5dc3640e00006c766b5e527ac462dd02616c766b5ac351936c766b5a527ac46c766b5ac36c766b59c3c09f63e7fe6c766b00c36168174e656f2e5472616e73616374696f6e2e476574486173686165dafc00a06c766b5f527ac46c766b5fc3640e00006c766b5e527ac46280026c766b00c361681a4e656f2e5472616e73616374696f6e2e4765744f7574707574736c766b53527ac4006c766b54527ac4616c766b53c36c766b60527ac4006c766b0111527ac46203016c766b60c36c766b0111c3c36c766b0112527ac4616c766b0112c36168184e656f2e4f75747075742e4765745363726970744861736861682d53797374656d2e457865637574696f6e456e67696e652e476574457865637574696e6753637269707448617368907c907c9e6347006c766b0112c36168154e656f2e4f75747075742e476574417373657449646120e72d286979ee6cb1b7e65dfddfb2e384100b8d148e7758de42e4168b71792c609c620400006c766b0113527ac46c766b0113c3642e00616c766b54c36c766b0112c36168134e656f2e4f75747075742e47657456616c7565936c766b54527ac461616c766b0111c351936c766b0111527ac46c766b0111c36c766b60c3c09f63f3fe6168164e656f2e53746f726167652e476574436f6e7465787408636f6e7472616374617c658b096c766b55527ac46c766b55c30b746f74616c537570706c79617c65030a6c766b56527ac46c766b56c36c766b54c3936c766b56527ac46c766b55c30b746f74616c537570706c796c766b56c361527265290a616168164e656f2e53746f726167652e476574436f6e74657874056173736574617c6514096c766b57527ac46c766b57c36c766b51c3617c6538096c766b58527ac46c766b57c36c766b51c36c766b58c36c766b54c39361527265260a61006c766b51c36c766b54c36152726596046161006c766b51c36c766b54c3615272087472616e7366657254c168124e656f2e52756e74696d652e4e6f7469667961516c766b5e527ac46203006c766b5ec3616c756600c56b084e45503520474153616c75660111c56b6c766b00527ac4616c766b00c3c001149c009c6c766b59527ac46c766b59c36436002f54686520706172616d657465722066726f6d2053484f554c442062652032302d62797465206164647265737365732e6175f061682953797374656d2e457865637574696f6e456e67696e652e476574536372697074436f6e7461696e65726c766b51527ac46c766b51c361681a4e656f2e5472616e73616374696f6e2e4765744f75747075747300c36c766b52527ac46c766b52c36168154e656f2e4f75747075742e476574417373657449646120e72d286979ee6cb1b7e65dfddfb2e384100b8d148e7758de42e4168b71792c609e6c766b5a527ac46c766b5ac3640e00006c766b5b527ac46228036c766b52c36168184e656f2e4f75747075742e4765745363726970744861736861682d53797374656d2e457865637574696f6e456e67696e652e476574457865637574696e67536372697074486173689e6c766b5c527ac46c766b5cc3640e00006c766b5b527ac462bd026168164e656f2e53746f726167652e476574436f6e7465787406726566756e64617c65d5066c766b53527ac46c766b53c36c766b51c36168174e656f2e5472616e73616374696f6e2e47657448617368617c65df06c000a06c766b5d527ac46c766b5dc3640e00006c766b5b527ac4624b026c766b00c36168184e656f2e52756e74696d652e436865636b5769746e657373009c6c766b5e527ac46c766b5ec3640e00006c766b5b527ac4620f026168164e656f2e53746f726167652e476574436f6e74657874056173736574617c6528066c766b54527ac46c766b54c36c766b00c3617c654c066c766b55527ac46c766b52c36168134e656f2e4f75747075742e47657456616c75656c766b56527ac46c766b55c36c766b56c39f6c766b5f527ac46c766b5fc3640e00006c766b5b527ac46287016c766b55c36c766b56c39c6c766b60527ac46c766b60c36416006c766b54c36c766b00c3617c653f0761621f006c766b54c36c766b00c36c766b55c36c766b56c39461527265c606616c766b53c36c766b51c36168174e656f2e5472616e73616374696f6e2e476574486173686c766b00c3615272654007616168164e656f2e53746f726167652e476574436f6e7465787408636f6e7472616374617c6524056c766b57527ac46c766b57c30b746f74616c537570706c79617c659c056c766b58527ac46c766b58c36c766b56c3946c766b58527ac46c766b57c30b746f74616c537570706c796c766b58c361527265c205616c766b00c3006c766b56c3615272658c0061616c766b00c3006c766b56c3615272087472616e7366657254c168124e656f2e52756e74696d652e4e6f7469667961616c766b51c36168174e656f2e5472616e73616374696f6e2e476574486173686c766b00c3617c06726566756e6453c168124e656f2e52756e74696d652e4e6f7469667961516c766b5b527ac46203006c766b5bc3616c756656c56b6c766b00527ac46c766b51527ac46c766b52527ac46161682953797374656d2e457865637574696f6e456e67696e652e476574536372697074436f6e7461696e65726168174e656f2e5472616e73616374696f6e2e476574486173686c766b53527ac46153c5766c766b00c3007cc4766c766b51c3517cc4766c766b52c3527cc46c766b54527ac46168164e656f2e53746f726167652e476574436f6e74657874067478496e666f617c6587036c766b55527ac46c766b55c36c766b53c36c766b54c36168154e656f2e52756e74696d652e53657269616c697a6561527265470561616c756600c56b0443474153616c756600c56b1c7b224e45502d35222c20224e45502d37222c20224e45502d3130227d616c756652c56b616168164e656f2e53746f726167652e476574436f6e7465787408636f6e7472616374617c65f3026c766b00527ac46c766b00c30b746f74616c537570706c79617c656b036c766b51527ac46203006c766b51c3616c756653c56b6c766b00527ac46c766b51527ac46c766b52527ac451616c75665fc56b6c766b00527ac46c766b51527ac46c766b52527ac46c766b53527ac4616c766b00c3c00114907c907c9e6311006c766b51c3c001149c009c620400516c766b57527ac46c766b57c3643e003754686520706172616d65746572732066726f6d20616e6420746f2053484f554c442062652032302d62797465206164647265737365732e6175f06c766b52c300a16c766b58527ac46c766b58c36433002c54686520706172616d6574657220616d6f756e74204d5553542062652067726561746572207468616e20302e6175f06c766b51c3616575f4009c6c766b59527ac46c766b59c3640e00006c766b5a527ac462a9016c766b00c36168184e656f2e52756e74696d652e436865636b5769746e6573736311006c766b00c36c766b53c39e620400006c766b5b527ac46c766b5bc3640e00006c766b5a527ac4625d016168164e656f2e53746f726167652e476574436f6e74657874056173736574617c6542016c766b54527ac46c766b54c36c766b00c3617c6566016c766b55527ac46c766b55c36c766b52c39f6c766b5c527ac46c766b5cc3640e00006c766b5a527ac462f7006c766b00c36c766b51c39c6c766b5d527ac46c766b5dc3640e00516c766b5a527ac462d2006c766b55c36c766b52c39c6c766b5e527ac46c766b5ec36416006c766b54c36c766b00c3617c65560261621f006c766b54c36c766b00c36c766b55c36c766b52c39461527265dd01616c766b54c36c766b51c3617c65bd006c766b56527ac46c766b54c36c766b51c36c766b56c36c766b52c39361527265ab01616c766b00c36c766b51c36c766b52c36152726517fc61616c766b00c36c766b51c36c766b52c3615272087472616e7366657254c168124e656f2e52756e74696d652e4e6f7469667961516c766b5a527ac46203006c766b5ac3616c756653c56b6c766b00527ac46c766b51527ac4616152c5766c766b00c3007cc4766c766b51c3517cc46c766b52527ac46203006c766b52c3616c756654c56b6c766b00527ac46c766b51527ac4616c766b00c351c301007e6c766b51c37e6c766b52527ac46c766b00c300c36c766b52c3617c680f4e656f2e53746f726167652e4765746c766b53527ac46203006c766b53c3616c756654c56b6c766b00527ac46c766b51527ac4616c766b00c351c301007e6c766b51c37e6c766b52527ac46c766b00c300c36c766b52c3617c680f4e656f2e53746f726167652e4765746c766b53527ac46203006c766b53c3616c756654c56b6c766b00527ac46c766b51527ac46c766b52527ac4616c766b00c351c301007e6c766b51c37e6c766b53527ac46c766b00c300c36c766b53c36c766b52c3615272680f4e656f2e53746f726167652e50757461616c756654c56b6c766b00527ac46c766b51527ac46c766b52527ac4616c766b00c351c301007e6c766b51c37e6c766b53527ac46c766b00c300c36c766b53c36c766b52c3615272680f4e656f2e53746f726167652e50757461616c756653c56b6c766b00527ac46c766b51527ac4616c766b00c351c301007e6c766b51c37e6c766b52527ac46c766b00c300c36c766b52c3617c68124e656f2e53746f726167652e44656c65746561616c756654c56b6c766b00527ac46c766b51527ac46c766b52527ac4616c766b00c351c301007e6c766b51c37e6c766b53527ac46c766b00c300c36c766b53c36c766b52c3615272680f4e656f2e53746f726167652e50757461616c7566"
            },
            {
                "invocation": "404c53a9ca937470df9dcbbb71cf00e2b4d75761e4667ccfd820e40829887c4444c7911ed509e564b2bac30e41c92c43f7df2dd2a25ea1c8e2bc10aec3d3208251",
                "verification": "21037ebe29fff57d8c177870e9d9eecb046b27fc290ccbac88a0e3da8bac5daa630dac"
            }
        ],
        "script": "14e8e3ce08268d16d867101feaf8c0ea130a923aba51c106726566756e646776db3192722022eb7841038246dc8fa636dcf274f1",
        "gas": "0",
        "blockhash": "0xd04d56259a6c92e290ab009e2062fbd078c3c371036d74dd745b379a4d55a899",
        "confirmations": 14,
        "blocktime": 1536907058
    }
}
```

refund 1st step application log:

```json
{
	"txid": "0x306daa4ab2b2ef73ff4fd8f9121fc926f5e21653080602b6841ad3f17f80777c",
	"vmstate": "HALT, BREAK",
	"gas_consumed": "5.582",
	"stack": [],
	"notifications": [{
		"contract": "0x74f2dc36a68fdc4682034178eb2220729231db76",
		"state": {
			"type": "Array",
			"value": [{
				"type": "ByteArray",
				"value": "7472616e73666572"
			}, {
				"type": "ByteArray",
				"value": "e8e3ce08268d16d867101feaf8c0ea130a923aba"
			}, {
				"type": "ByteArray",
				"value": ""
			}, {
				"type": "Integer",
				"value": "500000000"
			}]
		}
	}, {
		"contract": "0x74f2dc36a68fdc4682034178eb2220729231db76",
		"state": {
			"type": "Array",
			"value": [{
				"type": "ByteArray",
				"value": "726566756e64"
			}, {
				"type": "ByteArray",
				"value": "7c77807ff1d31a84b60206085316e2f526c91f12f9d84fff73efb2b24aaa6d30"
			}, {
				"type": "ByteArray",
				"value": "e8e3ce08268d16d867101feaf8c0ea130a923aba"
			}]
		}
	}]
}
```

refund 2nd step transaction:

> [NOTE]
>
> Type: ContractTransaction
>
> Input: from CGAS contract address
>
> Output: to user's address
>
> Scripts: witness of CGAS

```json
{
    "jsonrpc": "2.0",
    "id": 1,
    "result": {
        "txid": "0x595b1dce00e6a7c72e2650573b8b82831128428bd445830f226c1390bca8b45d",
        "size": 6969,
        "type": "ContractTransaction",
        "version": 0,
        "attributes": [],
        "vin": [
            {
                "txid": "0x306daa4ab2b2ef73ff4fd8f9121fc926f5e21653080602b6841ad3f17f80777c",
                "vout": 0
            }
        ],
        "vout": [
            {
                "n": 0,
                "asset": "0x602c79718b16e442de58778e148d0b1084e3b2dffd5de6b7b16cee7969282de7",
                "value": "5",
                "address": "Ad1HKAATNmFT5buNgSxspbW68f4XVSssSw"
            }
        ],
        "sys_fee": "0",
        "net_fee": "0",
        "scripts": [
            {
                "invocation": "520131",
                "verification": "012fc56b6c766b00527ac46c766b51527ac4616168164e656f2e52756e74696d652e47657454726967676572009c6c766b52527ac46c766b52c36418046161682953797374656d2e457865637574696f6e456e67696e652e476574536372697074436f6e7461696e65726c766b53527ac46c766b53c36168194e656f2e5472616e73616374696f6e2e476574496e707574736c766b54527ac46c766b53c361681a4e656f2e5472616e73616374696f6e2e4765744f7574707574736c766b55527ac4616c766b54c36c766b59527ac4006c766b5a527ac4622b016c766b59c36c766b5ac3c36c766b5b527ac4616c766b5bc36168124e656f2e496e7075742e476574496e646578009c6c766b5c527ac46c766b5cc364de00616168164e656f2e53746f726167652e476574436f6e7465787406726566756e64617c6545176c766b5d527ac46c766b5dc36c766b5bc36168114e656f2e496e7075742e47657448617368617c6555176c766b5e527ac46c766b5ec3c000a06c766b5f527ac46c766b5fc3646f00616c766b54c3c051907c907c9e6310006c766b55c3c0519c009c620400516c766b60527ac46c766b60c3640f00006c766b0111527ac4620f076c766b55c300c36168184e656f2e4f75747075742e476574536372697074486173686c766b5ec39c6c766b0111527ac462dc0661616c766b5ac351936c766b5a527ac46c766b5ac36c766b59c3c09f63ccfe61682d53797374656d2e457865637574696f6e456e67696e652e476574457865637574696e67536372697074486173686c766b56527ac4006c766b57527ac4616c766b53c361681d4e656f2e5472616e73616374696f6e2e4765745265666572656e6365736c766b0112527ac4006c766b0113527ac462e9006c766b0112c36c766b0113c3c36c766b0114527ac4616c766b0114c36168154e656f2e4f75747075742e476574417373657449646120e72d286979ee6cb1b7e65dfddfb2e384100b8d148e7758de42e4168b71792c609e6c766b0115527ac46c766b0115c3640f00006c766b0111527ac462d0056c766b0114c36168184e656f2e4f75747075742e476574536372697074486173686c766b56c39c6c766b0116527ac46c766b0116c3642c006c766b57c36c766b0114c36168134e656f2e4f75747075742e47657456616c7565936c766b57527ac4616c766b0113c351936c766b0113527ac46c766b0113c36c766b0112c3c09f630cff006c766b58527ac4616c766b55c36c766b0117527ac4006c766b0118527ac4628b006c766b0117c36c766b0118c3c36c766b0119527ac4616c766b0119c36168184e656f2e4f75747075742e476574536372697074486173686c766b56c39c6c766b011a527ac46c766b011ac3642c006c766b58c36c766b0119c36168134e656f2e4f75747075742e47657456616c7565936c766b58527ac4616c766b0118c351936c766b0118527ac46c766b0118c36c766b0117c3c09f636aff6c766b58c36c766b57c39c6c766b0111527ac4627c046168164e656f2e52756e74696d652e47657454726967676572609c6c766b011b527ac46c766b011bc3649e026161682b53797374656d2e457865637574696f6e456e67696e652e47657443616c6c696e67536372697074486173686c766b011c527ac46c766b00c30962616c616e63654f66876c766b011d527ac46c766b011dc36419006c766b51c300c36165f7036c766b0111527ac462e2036c766b00c308646563696d616c73876c766b011e527ac46c766b011ec3641200616570046c766b0111527ac462b3036c766b00c30f676574526566756e64546172676574876c766b011f527ac46c766b011fc36419006c766b51c300c361653b046c766b0111527ac46276036c766b00c3096765745478496e666f876c766b0120527ac46c766b0120c36419006c766b51c300c36165b1046c766b0111527ac4623f036c766b00c30a6d696e74546f6b656e73876c766b0121527ac46c766b0121c36412006165e6056c766b0111527ac4620e036c766b00c3046e616d65876c766b0122527ac46c766b0122c36412006165200a6c766b0111527ac462e3026c766b00c306726566756e64876c766b0123527ac46c766b0123c36419006c766b51c300c36165fc096c766b0111527ac462af026c766b00c30673796d626f6c876c766b0124527ac46c766b0124c36412006165f70e6c766b0111527ac46282026c766b00c312737570706f727465645374616e6461726473876c766b0125527ac46c766b0125c36412006165ca0e6c766b0111527ac46249026c766b00c30b746f74616c537570706c79876c766b0126527ac46c766b0126c36412006165bc0e6c766b0111527ac46217026c766b00c3087472616e73666572876c766b0127527ac46c766b0127c36441006c766b51c300c36c766b51c351c36c766b51c352c36c766b011cc361537951795572755172755279527954727552727565d60e6c766b0111527ac462b9016162a9016168164e656f2e52756e74696d652e47657454726967676572519c6c766b0128527ac46c766b0128c3647d016161682d53797374656d2e457865637574696f6e456e67696e652e476574457865637574696e67536372697074486173686c766b0129527ac461682953797374656d2e457865637574696f6e456e67696e652e476574536372697074436f6e7461696e65726c766b012a527ac4616c766b012ac361681a4e656f2e5472616e73616374696f6e2e4765744f7574707574736c766b012b527ac4006c766b012c527ac462bb006c766b012bc36c766b012cc3c36c766b012d527ac4616c766b012dc36168184e656f2e4f75747075742e476574536372697074486173686c766b0129c3907c907c9e6347006c766b012dc36168154e656f2e4f75747075742e476574417373657449646120e72d286979ee6cb1b7e65dfddfb2e384100b8d148e7758de42e4168b71792c609e620400006c766b012e527ac46c766b012ec3640f00006c766b0111527ac4623d00616c766b012cc351936c766b012c527ac46c766b012cc36c766b012bc3c09f633aff516c766b0111527ac4620f00006c766b0111527ac46203006c766b0111c3616c756654c56b6c766b00527ac4616c766b00c3c001149c009c6c766b52527ac46c766b52c36439003254686520706172616d65746572206163636f756e742053484f554c442062652032302d62797465206164647265737365732e6175f06168164e656f2e53746f726167652e476574436f6e74657874056173736574617c652f0f6c766b51527ac46c766b51c36c766b00c3617c65530f6c766b53527ac46203006c766b53c3616c756600c56b58616c756654c56b6c766b00527ac4616c766b00c3c001209c009c6c766b52527ac46c766b52c3643d003654686520706172616d6574657220747849642053484f554c442062652033322d62797465207472616e73616374696f6e20686173682e6175f06168164e656f2e53746f726167652e476574436f6e7465787406726566756e64617c657a0e6c766b51527ac46c766b51c36c766b00c3617c659e0e6c766b53527ac46203006c766b53c3616c756656c56b6c766b00527ac4616c766b00c3c001209c009c6c766b53527ac46c766b53c3643d003654686520706172616d6574657220747849642053484f554c442062652033322d62797465207472616e73616374696f6e20686173682e6175f06168164e656f2e53746f726167652e476574436f6e74657874067478496e666f617c65cd0d6c766b51527ac46c766b51c36c766b00c3617c65f10d6c766b52527ac46c766b52c3c0009c6c766b54527ac46c766b54c3640e00006c766b55527ac4622c006c766b52c36168174e656f2e52756e74696d652e446573657269616c697a656c766b55527ac46203006c766b55c3616c756653c56b6c766b00527ac4616c766b00c361681a4e656f2e426c6f636b636861696e2e476574436f6e74726163746c766b51527ac46c766b51c36424006c766b51c36168164e656f2e436f6e74726163742e497350617961626c65620400516c766b52527ac46203006c766b52c3616c75660114c56b6161682953797374656d2e457865637574696f6e456e67696e652e476574536372697074436f6e7461696e65726c766b00527ac4006c766b51527ac46c766b00c361681d4e656f2e5472616e73616374696f6e2e4765745265666572656e6365736c766b52527ac4616c766b52c36c766b59527ac4006c766b5a527ac46210016c766b59c36c766b5ac3c36c766b5b527ac4616c766b5bc36168154e656f2e4f75747075742e476574417373657449646120e72d286979ee6cb1b7e65dfddfb2e384100b8d148e7758de42e4168b71792c609c6c766b5c527ac46c766b5cc36434006c766b51c376632400756c766b5bc36168184e656f2e4f75747075742e476574536372697074486173686c766b51527ac46c766b5bc36168184e656f2e4f75747075742e4765745363726970744861736861682d53797374656d2e457865637574696f6e456e67696e652e476574457865637574696e67536372697074486173689c6c766b5d527ac46c766b5dc3640e00006c766b5e527ac462dd02616c766b5ac351936c766b5a527ac46c766b5ac36c766b59c3c09f63e7fe6c766b00c36168174e656f2e5472616e73616374696f6e2e476574486173686165dafc00a06c766b5f527ac46c766b5fc3640e00006c766b5e527ac46280026c766b00c361681a4e656f2e5472616e73616374696f6e2e4765744f7574707574736c766b53527ac4006c766b54527ac4616c766b53c36c766b60527ac4006c766b0111527ac46203016c766b60c36c766b0111c3c36c766b0112527ac4616c766b0112c36168184e656f2e4f75747075742e4765745363726970744861736861682d53797374656d2e457865637574696f6e456e67696e652e476574457865637574696e6753637269707448617368907c907c9e6347006c766b0112c36168154e656f2e4f75747075742e476574417373657449646120e72d286979ee6cb1b7e65dfddfb2e384100b8d148e7758de42e4168b71792c609c620400006c766b0113527ac46c766b0113c3642e00616c766b54c36c766b0112c36168134e656f2e4f75747075742e47657456616c7565936c766b54527ac461616c766b0111c351936c766b0111527ac46c766b0111c36c766b60c3c09f63f3fe6168164e656f2e53746f726167652e476574436f6e7465787408636f6e7472616374617c658b096c766b55527ac46c766b55c30b746f74616c537570706c79617c65030a6c766b56527ac46c766b56c36c766b54c3936c766b56527ac46c766b55c30b746f74616c537570706c796c766b56c361527265290a616168164e656f2e53746f726167652e476574436f6e74657874056173736574617c6514096c766b57527ac46c766b57c36c766b51c3617c6538096c766b58527ac46c766b57c36c766b51c36c766b58c36c766b54c39361527265260a61006c766b51c36c766b54c36152726596046161006c766b51c36c766b54c3615272087472616e7366657254c168124e656f2e52756e74696d652e4e6f7469667961516c766b5e527ac46203006c766b5ec3616c756600c56b084e45503520474153616c75660111c56b6c766b00527ac4616c766b00c3c001149c009c6c766b59527ac46c766b59c36436002f54686520706172616d657465722066726f6d2053484f554c442062652032302d62797465206164647265737365732e6175f061682953797374656d2e457865637574696f6e456e67696e652e476574536372697074436f6e7461696e65726c766b51527ac46c766b51c361681a4e656f2e5472616e73616374696f6e2e4765744f75747075747300c36c766b52527ac46c766b52c36168154e656f2e4f75747075742e476574417373657449646120e72d286979ee6cb1b7e65dfddfb2e384100b8d148e7758de42e4168b71792c609e6c766b5a527ac46c766b5ac3640e00006c766b5b527ac46228036c766b52c36168184e656f2e4f75747075742e4765745363726970744861736861682d53797374656d2e457865637574696f6e456e67696e652e476574457865637574696e67536372697074486173689e6c766b5c527ac46c766b5cc3640e00006c766b5b527ac462bd026168164e656f2e53746f726167652e476574436f6e7465787406726566756e64617c65d5066c766b53527ac46c766b53c36c766b51c36168174e656f2e5472616e73616374696f6e2e47657448617368617c65df06c000a06c766b5d527ac46c766b5dc3640e00006c766b5b527ac4624b026c766b00c36168184e656f2e52756e74696d652e436865636b5769746e657373009c6c766b5e527ac46c766b5ec3640e00006c766b5b527ac4620f026168164e656f2e53746f726167652e476574436f6e74657874056173736574617c6528066c766b54527ac46c766b54c36c766b00c3617c654c066c766b55527ac46c766b52c36168134e656f2e4f75747075742e47657456616c75656c766b56527ac46c766b55c36c766b56c39f6c766b5f527ac46c766b5fc3640e00006c766b5b527ac46287016c766b55c36c766b56c39c6c766b60527ac46c766b60c36416006c766b54c36c766b00c3617c653f0761621f006c766b54c36c766b00c36c766b55c36c766b56c39461527265c606616c766b53c36c766b51c36168174e656f2e5472616e73616374696f6e2e476574486173686c766b00c3615272654007616168164e656f2e53746f726167652e476574436f6e7465787408636f6e7472616374617c6524056c766b57527ac46c766b57c30b746f74616c537570706c79617c659c056c766b58527ac46c766b58c36c766b56c3946c766b58527ac46c766b57c30b746f74616c537570706c796c766b58c361527265c205616c766b00c3006c766b56c3615272658c0061616c766b00c3006c766b56c3615272087472616e7366657254c168124e656f2e52756e74696d652e4e6f7469667961616c766b51c36168174e656f2e5472616e73616374696f6e2e476574486173686c766b00c3617c06726566756e6453c168124e656f2e52756e74696d652e4e6f7469667961516c766b5b527ac46203006c766b5bc3616c756656c56b6c766b00527ac46c766b51527ac46c766b52527ac46161682953797374656d2e457865637574696f6e456e67696e652e476574536372697074436f6e7461696e65726168174e656f2e5472616e73616374696f6e2e476574486173686c766b53527ac46153c5766c766b00c3007cc4766c766b51c3517cc4766c766b52c3527cc46c766b54527ac46168164e656f2e53746f726167652e476574436f6e74657874067478496e666f617c6587036c766b55527ac46c766b55c36c766b53c36c766b54c36168154e656f2e52756e74696d652e53657269616c697a6561527265470561616c756600c56b0443474153616c756600c56b1c7b224e45502d35222c20224e45502d37222c20224e45502d3130227d616c756652c56b616168164e656f2e53746f726167652e476574436f6e7465787408636f6e7472616374617c65f3026c766b00527ac46c766b00c30b746f74616c537570706c79617c656b036c766b51527ac46203006c766b51c3616c756653c56b6c766b00527ac46c766b51527ac46c766b52527ac451616c75665fc56b6c766b00527ac46c766b51527ac46c766b52527ac46c766b53527ac4616c766b00c3c00114907c907c9e6311006c766b51c3c001149c009c620400516c766b57527ac46c766b57c3643e003754686520706172616d65746572732066726f6d20616e6420746f2053484f554c442062652032302d62797465206164647265737365732e6175f06c766b52c300a16c766b58527ac46c766b58c36433002c54686520706172616d6574657220616d6f756e74204d5553542062652067726561746572207468616e20302e6175f06c766b51c3616575f4009c6c766b59527ac46c766b59c3640e00006c766b5a527ac462a9016c766b00c36168184e656f2e52756e74696d652e436865636b5769746e6573736311006c766b00c36c766b53c39e620400006c766b5b527ac46c766b5bc3640e00006c766b5a527ac4625d016168164e656f2e53746f726167652e476574436f6e74657874056173736574617c6542016c766b54527ac46c766b54c36c766b00c3617c6566016c766b55527ac46c766b55c36c766b52c39f6c766b5c527ac46c766b5cc3640e00006c766b5a527ac462f7006c766b00c36c766b51c39c6c766b5d527ac46c766b5dc3640e00516c766b5a527ac462d2006c766b55c36c766b52c39c6c766b5e527ac46c766b5ec36416006c766b54c36c766b00c3617c65560261621f006c766b54c36c766b00c36c766b55c36c766b52c39461527265dd01616c766b54c36c766b51c3617c65bd006c766b56527ac46c766b54c36c766b51c36c766b56c36c766b52c39361527265ab01616c766b00c36c766b51c36c766b52c36152726517fc61616c766b00c36c766b51c36c766b52c3615272087472616e7366657254c168124e656f2e52756e74696d652e4e6f7469667961516c766b5a527ac46203006c766b5ac3616c756653c56b6c766b00527ac46c766b51527ac4616152c5766c766b00c3007cc4766c766b51c3517cc46c766b52527ac46203006c766b52c3616c756654c56b6c766b00527ac46c766b51527ac4616c766b00c351c301007e6c766b51c37e6c766b52527ac46c766b00c300c36c766b52c3617c680f4e656f2e53746f726167652e4765746c766b53527ac46203006c766b53c3616c756654c56b6c766b00527ac46c766b51527ac4616c766b00c351c301007e6c766b51c37e6c766b52527ac46c766b00c300c36c766b52c3617c680f4e656f2e53746f726167652e4765746c766b53527ac46203006c766b53c3616c756654c56b6c766b00527ac46c766b51527ac46c766b52527ac4616c766b00c351c301007e6c766b51c37e6c766b53527ac46c766b00c300c36c766b53c36c766b52c3615272680f4e656f2e53746f726167652e50757461616c756654c56b6c766b00527ac46c766b51527ac46c766b52527ac4616c766b00c351c301007e6c766b51c37e6c766b53527ac46c766b00c300c36c766b53c36c766b52c3615272680f4e656f2e53746f726167652e50757461616c756653c56b6c766b00527ac46c766b51527ac4616c766b00c351c301007e6c766b51c37e6c766b52527ac46c766b00c300c36c766b52c3617c68124e656f2e53746f726167652e44656c65746561616c756654c56b6c766b00527ac46c766b51527ac46c766b52527ac4616c766b00c351c301007e6c766b51c37e6c766b53527ac46c766b00c300c36c766b53c36c766b52c3615272680f4e656f2e53746f726167652e50757461616c7566"
            }
        ],
        "blockhash": "0x41590a481d67f2f52c2aaa6ca4942c17b1afc36e30cf417e7980011cd75ce905",
        "confirmations": 1,
        "blocktime": 1536907793
    }
}
```

refund 2nd step application log:

refund 2nd step is a ContractTransaction, so no application log.

<a name="zh"></a>

### 合约说明：

CGAS 是由 NGD（NEO Global Development）发布的符合 NEP-5 规范的合约资产，CGAS 可由 GAS 一比一地对换，并且支持退回操作。该合约的目的是将 GAS 进行全局资产的合约映射，使全局资产 GAS 可以方便地在合约内部流转，支持由合约调用转账。

### 技术介绍：

NEP-5 规范中的方法：

| 方法        | 参数                               | 返回值 | 描述                                                         |
| ----------- | ---------------------------------- | ------ | ------------------------------------------------------------ |
| balanceOf   | byte[] account                     | int    | 获得某个账户 CGAS 的余额，返回结果为真实值 × 10⁸             |
| decimals    | ---                                | int    | 获得 CGAS 精度，返回值为常量 `8`                             |
| name        | ---                                | string | 获得合约名称，返回值为常量 `NEP5 GAS`                        |
| symbol      | ---                                | string | 获得合约符号，返回值为常量 `CGAS`                            |
| totalSupply | ---                                | int    | 获得 CGAS 总发行量，返回结果为真实值 × 10⁸。因为 CGAS 与 GAS 为一比一兑换，所以合约地址中 GAS 的数量等于 CGAS 的总发行量 |
| transfer    | byte[] from, byte[] to, int amount | bool   | 转账方法，将 CGAS 从发送者（from）账户，转到接收者（to）账户，转账金额为 amount；from 与 to 为 Script Hash，amount 为实际转账金额 × 10⁸。该方法同时支持用户调用和合约调用。 |

该合约为了支持 GAS 与 CGAS 互换，除了满足 NEP-5 规范中的方法其它方法：

| 方法               | 参数        | 返回值                                      | 描述                                                         |
| ------------------ | ----------- | ------------------------------------------- | ------------------------------------------------------------ |
| getRefundTarget    | byte[] txId | byte[]                                      | 获得某个 UTXO 是谁待退回的，参数为 UTXO 中的交易 ID（确定一个 UTXO 由 txId 和 output 索引共同完成，这里 output 索引默认为 0），返回值为这个 UTXO 的退回者，他可以将这个 UTXO 作为交易输入，将 GAS 从 CGAS 地址中取走。 |
| getTxInfo          | byte[] txId | [TransferInfo](NeoContract/TransferInfo.cs) | 获得某个交易 ID 的详细转账信息，在以下 4 种情况中可记录 TxInfo：mintTokens, Refund, transfer, transferAPP。 |
| mintTokens         | ---         | bool                                        | CGAS 的铸币方法。用户通过发起 InvocationTransaction，将 GAS 转给 CGAS 合约地址，并且调用 mintTokens 完成 GAS 到 CGAS 的转换工作。合约调用成功后，用户资产中将会增加与兑换的 GAS 数额相等的 CGAS。[注意事项](#note-zh) |
| refund             | byte[] from | bool                                        | 用户将 CGAS 提取，变成 GAS 总共分两步。第一步，发起一笔 InvocationTransaction 其中包含一笔从 CGAS 地址到 CGAS 地址的 GAS 转账（转账金额为用户想退回的 GAS 的数量），并调用 refund 方法（参数为退回者的 Script Hash）。合约调用成功后，将自动销毁与退回数量相等的 CGAS，并把该交易的第 0 号 output 标记为所属于该用户。第二步，用户构造一个交易将第一步标记过的 UTXO 作为交易输入，交易输出为用户自己的地址，从而将 GAS 从 CGAS 地址中取走。 |
| supportedStandards | ---         | string                                      | NEP-10 规范，返回合约所支持的 NEP 标准，返回值为常量，数组格式：`{ "NEP-5", "NEP-7", "NEP-10" }` |

NEP-5 规范中的通知：



| 通知     | 参数                              | 描述                                                         |
| -------- | --------------------------------- | ------------------------------------------------------------ |
| transfer | byte[] from, byte[] to, int value | 通知中包含转账的 3 个要素，发送者 （from），接收者 （to） ，转账金额 （value）, 转账资产默认为 CGAS |

该合约实现的其它通知：

| 通知   | 参数                    | 描述                                                         |
| ------ | ----------------------- | ------------------------------------------------------------ |
| refund | byte[] txid, byte[] who | 通知中包含转账的 2 个要素，待退回的 UTXO（txid），退回者的 Script Hash（who） |

<a name="note-zh"></a>

> [注意]
>
> 在 mintTokens 的时候请注意，InvocationTransaction 的 Inputs 和 Output 加起来不应该超过60个，否则在执行时所需的手续费会超过 10 GAS 的免费额度。如果有大量 GAS 的 UTXO 需要换成 CGAS，建议先进行一个普通转账，将 UTXO 合并，然后再进行 mintTokens 操作。

### 示例

以下是 `mintTokens` 和 `refund` 的交易结构以及 Application Log，供开发者参考。

mintTokens 交易结构:

> [说明]
>
> Type: InvocationTransaction
>
> Input: 来自用户的地址
>
> Output: CGAS 合约地址
>
> Script: 调用 CGAS 合约的 mintTokens 方法

```json
{
    "jsonrpc": "2.0",
    "id": 1,
    "result": {
        "txid": "0x48bd784d0ed6000cba64d0e303117e4c10081e3268afcf3b07e8b353a7594772",
        "size": 246,
        "type": "InvocationTransaction",
        "version": 1,
        "attributes": [],
        "vin": [
            {
                "txid": "0x5918258bb67ee292358f8780d6b86e8fcd825bdde623429e4e547a2f9e496cf8",
                "vout": 0
            }
        ],
        "vout": [
            {
                "n": 0,
                "asset": "0x602c79718b16e442de58778e148d0b1084e3b2dffd5de6b7b16cee7969282de7",
                "value": "10",
                "address": "AScKxyXmNtEnTLTvbVhNQyTJmgytxhwSnM"
            }
        ],
        "sys_fee": "0",
        "net_fee": "0",
        "scripts": [
            {
                "invocation": "408e13fc267d69ca1c8463ac8bc3f266343ee0661ef85e9fa66fe986dc787f14fc6c13279bc90883297e186ca65d918ccdcf407497c0de1de9573e9a519a4f9aa5",
                "verification": "21037ebe29fff57d8c177870e9d9eecb046b27fc290ccbac88a0e3da8bac5daa630dac"
            }
        ],
        "script": "000a6d696e74546f6b656e736776db3192722022eb7841038246dc8fa636dcf274f16658600e9b9af88bcb",
        "gas": "0",
        "blockhash": "0xafb5b19021e1b57e7d64deb9d99bedabb0e40fdc3393d6c58c324730c0061aae",
        "confirmations": 2,
        "blocktime": 1536906512
    }
}
```

mintTokens application log:

```json
{
	"txid": "0x48bd784d0ed6000cba64d0e303117e4c10081e3268afcf3b07e8b353a7594772",
	"vmstate": "HALT, BREAK",
	"gas_consumed": "4.648",
	"stack": [],
	"notifications": [{
		"contract": "0x74f2dc36a68fdc4682034178eb2220729231db76",
		"state": {
			"type": "Array",
			"value": [{
				"type": "ByteArray",
				"value": "7472616e73666572"
			}, {
				"type": "ByteArray",
				"value": ""
			}, {
				"type": "ByteArray",
				"value": "e8e3ce08268d16d867101feaf8c0ea130a923aba"
			}, {
				"type": "Integer",
				"value": "1000000000"
			}]
		}
	}]
}
```

refund 第一步时的交易结构:

> [说明]
>
> Type: InvocationTransaction
>
> Input: 来自 CGAS 合约地址
>
> Output: 转到 CGAS 合约地址 (与 input 相同)
>
> Script: 调用 refund 方法，设置参数为退回者的 Script Hash
>
> Scripts: 需要两个 witness: 1、CGAS 合约的 witness; 2、用户的 witness（附加见证人）

```json
{
    "jsonrpc": "2.0",
    "id": 1,
    "result": {
        "txid": "0x306daa4ab2b2ef73ff4fd8f9121fc926f5e21653080602b6841ad3f17f80777c",
        "size": 7205,
        "type": "InvocationTransaction",
        "version": 0,
        "attributes": [
            {
                "usage": "Script",
                "data": "e8e3ce08268d16d867101feaf8c0ea130a923aba"
            }
        ],
        "vin": [
            {
                "txid": "0x48bd784d0ed6000cba64d0e303117e4c10081e3268afcf3b07e8b353a7594772",
                "vout": 0
            }
        ],
        "vout": [
            {
                "n": 0,
                "asset": "0x602c79718b16e442de58778e148d0b1084e3b2dffd5de6b7b16cee7969282de7",
                "value": "5",
                "address": "AScKxyXmNtEnTLTvbVhNQyTJmgytxhwSnM"
            },
            {
                "n": 1,
                "asset": "0x602c79718b16e442de58778e148d0b1084e3b2dffd5de6b7b16cee7969282de7",
                "value": "5",
                "address": "AScKxyXmNtEnTLTvbVhNQyTJmgytxhwSnM"
            }
        ],
        "sys_fee": "0",
        "net_fee": "0",
        "scripts": [
            {
                "invocation": "520131",
                "verification": "012fc56b6c766b00527ac46c766b51527ac4616168164e656f2e52756e74696d652e47657454726967676572009c6c766b52527ac46c766b52c36418046161682953797374656d2e457865637574696f6e456e67696e652e476574536372697074436f6e7461696e65726c766b53527ac46c766b53c36168194e656f2e5472616e73616374696f6e2e476574496e707574736c766b54527ac46c766b53c361681a4e656f2e5472616e73616374696f6e2e4765744f7574707574736c766b55527ac4616c766b54c36c766b59527ac4006c766b5a527ac4622b016c766b59c36c766b5ac3c36c766b5b527ac4616c766b5bc36168124e656f2e496e7075742e476574496e646578009c6c766b5c527ac46c766b5cc364de00616168164e656f2e53746f726167652e476574436f6e7465787406726566756e64617c6545176c766b5d527ac46c766b5dc36c766b5bc36168114e656f2e496e7075742e47657448617368617c6555176c766b5e527ac46c766b5ec3c000a06c766b5f527ac46c766b5fc3646f00616c766b54c3c051907c907c9e6310006c766b55c3c0519c009c620400516c766b60527ac46c766b60c3640f00006c766b0111527ac4620f076c766b55c300c36168184e656f2e4f75747075742e476574536372697074486173686c766b5ec39c6c766b0111527ac462dc0661616c766b5ac351936c766b5a527ac46c766b5ac36c766b59c3c09f63ccfe61682d53797374656d2e457865637574696f6e456e67696e652e476574457865637574696e67536372697074486173686c766b56527ac4006c766b57527ac4616c766b53c361681d4e656f2e5472616e73616374696f6e2e4765745265666572656e6365736c766b0112527ac4006c766b0113527ac462e9006c766b0112c36c766b0113c3c36c766b0114527ac4616c766b0114c36168154e656f2e4f75747075742e476574417373657449646120e72d286979ee6cb1b7e65dfddfb2e384100b8d148e7758de42e4168b71792c609e6c766b0115527ac46c766b0115c3640f00006c766b0111527ac462d0056c766b0114c36168184e656f2e4f75747075742e476574536372697074486173686c766b56c39c6c766b0116527ac46c766b0116c3642c006c766b57c36c766b0114c36168134e656f2e4f75747075742e47657456616c7565936c766b57527ac4616c766b0113c351936c766b0113527ac46c766b0113c36c766b0112c3c09f630cff006c766b58527ac4616c766b55c36c766b0117527ac4006c766b0118527ac4628b006c766b0117c36c766b0118c3c36c766b0119527ac4616c766b0119c36168184e656f2e4f75747075742e476574536372697074486173686c766b56c39c6c766b011a527ac46c766b011ac3642c006c766b58c36c766b0119c36168134e656f2e4f75747075742e47657456616c7565936c766b58527ac4616c766b0118c351936c766b0118527ac46c766b0118c36c766b0117c3c09f636aff6c766b58c36c766b57c39c6c766b0111527ac4627c046168164e656f2e52756e74696d652e47657454726967676572609c6c766b011b527ac46c766b011bc3649e026161682b53797374656d2e457865637574696f6e456e67696e652e47657443616c6c696e67536372697074486173686c766b011c527ac46c766b00c30962616c616e63654f66876c766b011d527ac46c766b011dc36419006c766b51c300c36165f7036c766b0111527ac462e2036c766b00c308646563696d616c73876c766b011e527ac46c766b011ec3641200616570046c766b0111527ac462b3036c766b00c30f676574526566756e64546172676574876c766b011f527ac46c766b011fc36419006c766b51c300c361653b046c766b0111527ac46276036c766b00c3096765745478496e666f876c766b0120527ac46c766b0120c36419006c766b51c300c36165b1046c766b0111527ac4623f036c766b00c30a6d696e74546f6b656e73876c766b0121527ac46c766b0121c36412006165e6056c766b0111527ac4620e036c766b00c3046e616d65876c766b0122527ac46c766b0122c36412006165200a6c766b0111527ac462e3026c766b00c306726566756e64876c766b0123527ac46c766b0123c36419006c766b51c300c36165fc096c766b0111527ac462af026c766b00c30673796d626f6c876c766b0124527ac46c766b0124c36412006165f70e6c766b0111527ac46282026c766b00c312737570706f727465645374616e6461726473876c766b0125527ac46c766b0125c36412006165ca0e6c766b0111527ac46249026c766b00c30b746f74616c537570706c79876c766b0126527ac46c766b0126c36412006165bc0e6c766b0111527ac46217026c766b00c3087472616e73666572876c766b0127527ac46c766b0127c36441006c766b51c300c36c766b51c351c36c766b51c352c36c766b011cc361537951795572755172755279527954727552727565d60e6c766b0111527ac462b9016162a9016168164e656f2e52756e74696d652e47657454726967676572519c6c766b0128527ac46c766b0128c3647d016161682d53797374656d2e457865637574696f6e456e67696e652e476574457865637574696e67536372697074486173686c766b0129527ac461682953797374656d2e457865637574696f6e456e67696e652e476574536372697074436f6e7461696e65726c766b012a527ac4616c766b012ac361681a4e656f2e5472616e73616374696f6e2e4765744f7574707574736c766b012b527ac4006c766b012c527ac462bb006c766b012bc36c766b012cc3c36c766b012d527ac4616c766b012dc36168184e656f2e4f75747075742e476574536372697074486173686c766b0129c3907c907c9e6347006c766b012dc36168154e656f2e4f75747075742e476574417373657449646120e72d286979ee6cb1b7e65dfddfb2e384100b8d148e7758de42e4168b71792c609e620400006c766b012e527ac46c766b012ec3640f00006c766b0111527ac4623d00616c766b012cc351936c766b012c527ac46c766b012cc36c766b012bc3c09f633aff516c766b0111527ac4620f00006c766b0111527ac46203006c766b0111c3616c756654c56b6c766b00527ac4616c766b00c3c001149c009c6c766b52527ac46c766b52c36439003254686520706172616d65746572206163636f756e742053484f554c442062652032302d62797465206164647265737365732e6175f06168164e656f2e53746f726167652e476574436f6e74657874056173736574617c652f0f6c766b51527ac46c766b51c36c766b00c3617c65530f6c766b53527ac46203006c766b53c3616c756600c56b58616c756654c56b6c766b00527ac4616c766b00c3c001209c009c6c766b52527ac46c766b52c3643d003654686520706172616d6574657220747849642053484f554c442062652033322d62797465207472616e73616374696f6e20686173682e6175f06168164e656f2e53746f726167652e476574436f6e7465787406726566756e64617c657a0e6c766b51527ac46c766b51c36c766b00c3617c659e0e6c766b53527ac46203006c766b53c3616c756656c56b6c766b00527ac4616c766b00c3c001209c009c6c766b53527ac46c766b53c3643d003654686520706172616d6574657220747849642053484f554c442062652033322d62797465207472616e73616374696f6e20686173682e6175f06168164e656f2e53746f726167652e476574436f6e74657874067478496e666f617c65cd0d6c766b51527ac46c766b51c36c766b00c3617c65f10d6c766b52527ac46c766b52c3c0009c6c766b54527ac46c766b54c3640e00006c766b55527ac4622c006c766b52c36168174e656f2e52756e74696d652e446573657269616c697a656c766b55527ac46203006c766b55c3616c756653c56b6c766b00527ac4616c766b00c361681a4e656f2e426c6f636b636861696e2e476574436f6e74726163746c766b51527ac46c766b51c36424006c766b51c36168164e656f2e436f6e74726163742e497350617961626c65620400516c766b52527ac46203006c766b52c3616c75660114c56b6161682953797374656d2e457865637574696f6e456e67696e652e476574536372697074436f6e7461696e65726c766b00527ac4006c766b51527ac46c766b00c361681d4e656f2e5472616e73616374696f6e2e4765745265666572656e6365736c766b52527ac4616c766b52c36c766b59527ac4006c766b5a527ac46210016c766b59c36c766b5ac3c36c766b5b527ac4616c766b5bc36168154e656f2e4f75747075742e476574417373657449646120e72d286979ee6cb1b7e65dfddfb2e384100b8d148e7758de42e4168b71792c609c6c766b5c527ac46c766b5cc36434006c766b51c376632400756c766b5bc36168184e656f2e4f75747075742e476574536372697074486173686c766b51527ac46c766b5bc36168184e656f2e4f75747075742e4765745363726970744861736861682d53797374656d2e457865637574696f6e456e67696e652e476574457865637574696e67536372697074486173689c6c766b5d527ac46c766b5dc3640e00006c766b5e527ac462dd02616c766b5ac351936c766b5a527ac46c766b5ac36c766b59c3c09f63e7fe6c766b00c36168174e656f2e5472616e73616374696f6e2e476574486173686165dafc00a06c766b5f527ac46c766b5fc3640e00006c766b5e527ac46280026c766b00c361681a4e656f2e5472616e73616374696f6e2e4765744f7574707574736c766b53527ac4006c766b54527ac4616c766b53c36c766b60527ac4006c766b0111527ac46203016c766b60c36c766b0111c3c36c766b0112527ac4616c766b0112c36168184e656f2e4f75747075742e4765745363726970744861736861682d53797374656d2e457865637574696f6e456e67696e652e476574457865637574696e6753637269707448617368907c907c9e6347006c766b0112c36168154e656f2e4f75747075742e476574417373657449646120e72d286979ee6cb1b7e65dfddfb2e384100b8d148e7758de42e4168b71792c609c620400006c766b0113527ac46c766b0113c3642e00616c766b54c36c766b0112c36168134e656f2e4f75747075742e47657456616c7565936c766b54527ac461616c766b0111c351936c766b0111527ac46c766b0111c36c766b60c3c09f63f3fe6168164e656f2e53746f726167652e476574436f6e7465787408636f6e7472616374617c658b096c766b55527ac46c766b55c30b746f74616c537570706c79617c65030a6c766b56527ac46c766b56c36c766b54c3936c766b56527ac46c766b55c30b746f74616c537570706c796c766b56c361527265290a616168164e656f2e53746f726167652e476574436f6e74657874056173736574617c6514096c766b57527ac46c766b57c36c766b51c3617c6538096c766b58527ac46c766b57c36c766b51c36c766b58c36c766b54c39361527265260a61006c766b51c36c766b54c36152726596046161006c766b51c36c766b54c3615272087472616e7366657254c168124e656f2e52756e74696d652e4e6f7469667961516c766b5e527ac46203006c766b5ec3616c756600c56b084e45503520474153616c75660111c56b6c766b00527ac4616c766b00c3c001149c009c6c766b59527ac46c766b59c36436002f54686520706172616d657465722066726f6d2053484f554c442062652032302d62797465206164647265737365732e6175f061682953797374656d2e457865637574696f6e456e67696e652e476574536372697074436f6e7461696e65726c766b51527ac46c766b51c361681a4e656f2e5472616e73616374696f6e2e4765744f75747075747300c36c766b52527ac46c766b52c36168154e656f2e4f75747075742e476574417373657449646120e72d286979ee6cb1b7e65dfddfb2e384100b8d148e7758de42e4168b71792c609e6c766b5a527ac46c766b5ac3640e00006c766b5b527ac46228036c766b52c36168184e656f2e4f75747075742e4765745363726970744861736861682d53797374656d2e457865637574696f6e456e67696e652e476574457865637574696e67536372697074486173689e6c766b5c527ac46c766b5cc3640e00006c766b5b527ac462bd026168164e656f2e53746f726167652e476574436f6e7465787406726566756e64617c65d5066c766b53527ac46c766b53c36c766b51c36168174e656f2e5472616e73616374696f6e2e47657448617368617c65df06c000a06c766b5d527ac46c766b5dc3640e00006c766b5b527ac4624b026c766b00c36168184e656f2e52756e74696d652e436865636b5769746e657373009c6c766b5e527ac46c766b5ec3640e00006c766b5b527ac4620f026168164e656f2e53746f726167652e476574436f6e74657874056173736574617c6528066c766b54527ac46c766b54c36c766b00c3617c654c066c766b55527ac46c766b52c36168134e656f2e4f75747075742e47657456616c75656c766b56527ac46c766b55c36c766b56c39f6c766b5f527ac46c766b5fc3640e00006c766b5b527ac46287016c766b55c36c766b56c39c6c766b60527ac46c766b60c36416006c766b54c36c766b00c3617c653f0761621f006c766b54c36c766b00c36c766b55c36c766b56c39461527265c606616c766b53c36c766b51c36168174e656f2e5472616e73616374696f6e2e476574486173686c766b00c3615272654007616168164e656f2e53746f726167652e476574436f6e7465787408636f6e7472616374617c6524056c766b57527ac46c766b57c30b746f74616c537570706c79617c659c056c766b58527ac46c766b58c36c766b56c3946c766b58527ac46c766b57c30b746f74616c537570706c796c766b58c361527265c205616c766b00c3006c766b56c3615272658c0061616c766b00c3006c766b56c3615272087472616e7366657254c168124e656f2e52756e74696d652e4e6f7469667961616c766b51c36168174e656f2e5472616e73616374696f6e2e476574486173686c766b00c3617c06726566756e6453c168124e656f2e52756e74696d652e4e6f7469667961516c766b5b527ac46203006c766b5bc3616c756656c56b6c766b00527ac46c766b51527ac46c766b52527ac46161682953797374656d2e457865637574696f6e456e67696e652e476574536372697074436f6e7461696e65726168174e656f2e5472616e73616374696f6e2e476574486173686c766b53527ac46153c5766c766b00c3007cc4766c766b51c3517cc4766c766b52c3527cc46c766b54527ac46168164e656f2e53746f726167652e476574436f6e74657874067478496e666f617c6587036c766b55527ac46c766b55c36c766b53c36c766b54c36168154e656f2e52756e74696d652e53657269616c697a6561527265470561616c756600c56b0443474153616c756600c56b1c7b224e45502d35222c20224e45502d37222c20224e45502d3130227d616c756652c56b616168164e656f2e53746f726167652e476574436f6e7465787408636f6e7472616374617c65f3026c766b00527ac46c766b00c30b746f74616c537570706c79617c656b036c766b51527ac46203006c766b51c3616c756653c56b6c766b00527ac46c766b51527ac46c766b52527ac451616c75665fc56b6c766b00527ac46c766b51527ac46c766b52527ac46c766b53527ac4616c766b00c3c00114907c907c9e6311006c766b51c3c001149c009c620400516c766b57527ac46c766b57c3643e003754686520706172616d65746572732066726f6d20616e6420746f2053484f554c442062652032302d62797465206164647265737365732e6175f06c766b52c300a16c766b58527ac46c766b58c36433002c54686520706172616d6574657220616d6f756e74204d5553542062652067726561746572207468616e20302e6175f06c766b51c3616575f4009c6c766b59527ac46c766b59c3640e00006c766b5a527ac462a9016c766b00c36168184e656f2e52756e74696d652e436865636b5769746e6573736311006c766b00c36c766b53c39e620400006c766b5b527ac46c766b5bc3640e00006c766b5a527ac4625d016168164e656f2e53746f726167652e476574436f6e74657874056173736574617c6542016c766b54527ac46c766b54c36c766b00c3617c6566016c766b55527ac46c766b55c36c766b52c39f6c766b5c527ac46c766b5cc3640e00006c766b5a527ac462f7006c766b00c36c766b51c39c6c766b5d527ac46c766b5dc3640e00516c766b5a527ac462d2006c766b55c36c766b52c39c6c766b5e527ac46c766b5ec36416006c766b54c36c766b00c3617c65560261621f006c766b54c36c766b00c36c766b55c36c766b52c39461527265dd01616c766b54c36c766b51c3617c65bd006c766b56527ac46c766b54c36c766b51c36c766b56c36c766b52c39361527265ab01616c766b00c36c766b51c36c766b52c36152726517fc61616c766b00c36c766b51c36c766b52c3615272087472616e7366657254c168124e656f2e52756e74696d652e4e6f7469667961516c766b5a527ac46203006c766b5ac3616c756653c56b6c766b00527ac46c766b51527ac4616152c5766c766b00c3007cc4766c766b51c3517cc46c766b52527ac46203006c766b52c3616c756654c56b6c766b00527ac46c766b51527ac4616c766b00c351c301007e6c766b51c37e6c766b52527ac46c766b00c300c36c766b52c3617c680f4e656f2e53746f726167652e4765746c766b53527ac46203006c766b53c3616c756654c56b6c766b00527ac46c766b51527ac4616c766b00c351c301007e6c766b51c37e6c766b52527ac46c766b00c300c36c766b52c3617c680f4e656f2e53746f726167652e4765746c766b53527ac46203006c766b53c3616c756654c56b6c766b00527ac46c766b51527ac46c766b52527ac4616c766b00c351c301007e6c766b51c37e6c766b53527ac46c766b00c300c36c766b53c36c766b52c3615272680f4e656f2e53746f726167652e50757461616c756654c56b6c766b00527ac46c766b51527ac46c766b52527ac4616c766b00c351c301007e6c766b51c37e6c766b53527ac46c766b00c300c36c766b53c36c766b52c3615272680f4e656f2e53746f726167652e50757461616c756653c56b6c766b00527ac46c766b51527ac4616c766b00c351c301007e6c766b51c37e6c766b52527ac46c766b00c300c36c766b52c3617c68124e656f2e53746f726167652e44656c65746561616c756654c56b6c766b00527ac46c766b51527ac46c766b52527ac4616c766b00c351c301007e6c766b51c37e6c766b53527ac46c766b00c300c36c766b53c36c766b52c3615272680f4e656f2e53746f726167652e50757461616c7566"
            },
            {
                "invocation": "404c53a9ca937470df9dcbbb71cf00e2b4d75761e4667ccfd820e40829887c4444c7911ed509e564b2bac30e41c92c43f7df2dd2a25ea1c8e2bc10aec3d3208251",
                "verification": "21037ebe29fff57d8c177870e9d9eecb046b27fc290ccbac88a0e3da8bac5daa630dac"
            }
        ],
        "script": "14e8e3ce08268d16d867101feaf8c0ea130a923aba51c106726566756e646776db3192722022eb7841038246dc8fa636dcf274f1",
        "gas": "0",
        "blockhash": "0xd04d56259a6c92e290ab009e2062fbd078c3c371036d74dd745b379a4d55a899",
        "confirmations": 14,
        "blocktime": 1536907058
    }
}
```

refund 第一步的 application log:

```json
{
	"txid": "0x306daa4ab2b2ef73ff4fd8f9121fc926f5e21653080602b6841ad3f17f80777c",
	"vmstate": "HALT, BREAK",
	"gas_consumed": "5.582",
	"stack": [],
	"notifications": [{
		"contract": "0x74f2dc36a68fdc4682034178eb2220729231db76",
		"state": {
			"type": "Array",
			"value": [{
				"type": "ByteArray",
				"value": "7472616e73666572"
			}, {
				"type": "ByteArray",
				"value": "e8e3ce08268d16d867101feaf8c0ea130a923aba"
			}, {
				"type": "ByteArray",
				"value": ""
			}, {
				"type": "Integer",
				"value": "500000000"
			}]
		}
	}, {
		"contract": "0x74f2dc36a68fdc4682034178eb2220729231db76",
		"state": {
			"type": "Array",
			"value": [{
				"type": "ByteArray",
				"value": "726566756e64"
			}, {
				"type": "ByteArray",
				"value": "7c77807ff1d31a84b60206085316e2f526c91f12f9d84fff73efb2b24aaa6d30"
			}, {
				"type": "ByteArray",
				"value": "e8e3ce08268d16d867101feaf8c0ea130a923aba"
			}]
		}
	}]
}
```

refund 第二步的交易结构:

> [说明]
>
> Type: ContractTransaction
>
> Input: 来自 CGAS 合约地址
>
> Output: 转到用户自己的地址
>
> Scripts: CGAS 合约的 witness

```json
{
    "jsonrpc": "2.0",
    "id": 1,
    "result": {
        "txid": "0x595b1dce00e6a7c72e2650573b8b82831128428bd445830f226c1390bca8b45d",
        "size": 6969,
        "type": "ContractTransaction",
        "version": 0,
        "attributes": [],
        "vin": [
            {
                "txid": "0x306daa4ab2b2ef73ff4fd8f9121fc926f5e21653080602b6841ad3f17f80777c",
                "vout": 0
            }
        ],
        "vout": [
            {
                "n": 0,
                "asset": "0x602c79718b16e442de58778e148d0b1084e3b2dffd5de6b7b16cee7969282de7",
                "value": "5",
                "address": "Ad1HKAATNmFT5buNgSxspbW68f4XVSssSw"
            }
        ],
        "sys_fee": "0",
        "net_fee": "0",
        "scripts": [
            {
                "invocation": "520131",
                "verification": "012fc56b6c766b00527ac46c766b51527ac4616168164e656f2e52756e74696d652e47657454726967676572009c6c766b52527ac46c766b52c36418046161682953797374656d2e457865637574696f6e456e67696e652e476574536372697074436f6e7461696e65726c766b53527ac46c766b53c36168194e656f2e5472616e73616374696f6e2e476574496e707574736c766b54527ac46c766b53c361681a4e656f2e5472616e73616374696f6e2e4765744f7574707574736c766b55527ac4616c766b54c36c766b59527ac4006c766b5a527ac4622b016c766b59c36c766b5ac3c36c766b5b527ac4616c766b5bc36168124e656f2e496e7075742e476574496e646578009c6c766b5c527ac46c766b5cc364de00616168164e656f2e53746f726167652e476574436f6e7465787406726566756e64617c6545176c766b5d527ac46c766b5dc36c766b5bc36168114e656f2e496e7075742e47657448617368617c6555176c766b5e527ac46c766b5ec3c000a06c766b5f527ac46c766b5fc3646f00616c766b54c3c051907c907c9e6310006c766b55c3c0519c009c620400516c766b60527ac46c766b60c3640f00006c766b0111527ac4620f076c766b55c300c36168184e656f2e4f75747075742e476574536372697074486173686c766b5ec39c6c766b0111527ac462dc0661616c766b5ac351936c766b5a527ac46c766b5ac36c766b59c3c09f63ccfe61682d53797374656d2e457865637574696f6e456e67696e652e476574457865637574696e67536372697074486173686c766b56527ac4006c766b57527ac4616c766b53c361681d4e656f2e5472616e73616374696f6e2e4765745265666572656e6365736c766b0112527ac4006c766b0113527ac462e9006c766b0112c36c766b0113c3c36c766b0114527ac4616c766b0114c36168154e656f2e4f75747075742e476574417373657449646120e72d286979ee6cb1b7e65dfddfb2e384100b8d148e7758de42e4168b71792c609e6c766b0115527ac46c766b0115c3640f00006c766b0111527ac462d0056c766b0114c36168184e656f2e4f75747075742e476574536372697074486173686c766b56c39c6c766b0116527ac46c766b0116c3642c006c766b57c36c766b0114c36168134e656f2e4f75747075742e47657456616c7565936c766b57527ac4616c766b0113c351936c766b0113527ac46c766b0113c36c766b0112c3c09f630cff006c766b58527ac4616c766b55c36c766b0117527ac4006c766b0118527ac4628b006c766b0117c36c766b0118c3c36c766b0119527ac4616c766b0119c36168184e656f2e4f75747075742e476574536372697074486173686c766b56c39c6c766b011a527ac46c766b011ac3642c006c766b58c36c766b0119c36168134e656f2e4f75747075742e47657456616c7565936c766b58527ac4616c766b0118c351936c766b0118527ac46c766b0118c36c766b0117c3c09f636aff6c766b58c36c766b57c39c6c766b0111527ac4627c046168164e656f2e52756e74696d652e47657454726967676572609c6c766b011b527ac46c766b011bc3649e026161682b53797374656d2e457865637574696f6e456e67696e652e47657443616c6c696e67536372697074486173686c766b011c527ac46c766b00c30962616c616e63654f66876c766b011d527ac46c766b011dc36419006c766b51c300c36165f7036c766b0111527ac462e2036c766b00c308646563696d616c73876c766b011e527ac46c766b011ec3641200616570046c766b0111527ac462b3036c766b00c30f676574526566756e64546172676574876c766b011f527ac46c766b011fc36419006c766b51c300c361653b046c766b0111527ac46276036c766b00c3096765745478496e666f876c766b0120527ac46c766b0120c36419006c766b51c300c36165b1046c766b0111527ac4623f036c766b00c30a6d696e74546f6b656e73876c766b0121527ac46c766b0121c36412006165e6056c766b0111527ac4620e036c766b00c3046e616d65876c766b0122527ac46c766b0122c36412006165200a6c766b0111527ac462e3026c766b00c306726566756e64876c766b0123527ac46c766b0123c36419006c766b51c300c36165fc096c766b0111527ac462af026c766b00c30673796d626f6c876c766b0124527ac46c766b0124c36412006165f70e6c766b0111527ac46282026c766b00c312737570706f727465645374616e6461726473876c766b0125527ac46c766b0125c36412006165ca0e6c766b0111527ac46249026c766b00c30b746f74616c537570706c79876c766b0126527ac46c766b0126c36412006165bc0e6c766b0111527ac46217026c766b00c3087472616e73666572876c766b0127527ac46c766b0127c36441006c766b51c300c36c766b51c351c36c766b51c352c36c766b011cc361537951795572755172755279527954727552727565d60e6c766b0111527ac462b9016162a9016168164e656f2e52756e74696d652e47657454726967676572519c6c766b0128527ac46c766b0128c3647d016161682d53797374656d2e457865637574696f6e456e67696e652e476574457865637574696e67536372697074486173686c766b0129527ac461682953797374656d2e457865637574696f6e456e67696e652e476574536372697074436f6e7461696e65726c766b012a527ac4616c766b012ac361681a4e656f2e5472616e73616374696f6e2e4765744f7574707574736c766b012b527ac4006c766b012c527ac462bb006c766b012bc36c766b012cc3c36c766b012d527ac4616c766b012dc36168184e656f2e4f75747075742e476574536372697074486173686c766b0129c3907c907c9e6347006c766b012dc36168154e656f2e4f75747075742e476574417373657449646120e72d286979ee6cb1b7e65dfddfb2e384100b8d148e7758de42e4168b71792c609e620400006c766b012e527ac46c766b012ec3640f00006c766b0111527ac4623d00616c766b012cc351936c766b012c527ac46c766b012cc36c766b012bc3c09f633aff516c766b0111527ac4620f00006c766b0111527ac46203006c766b0111c3616c756654c56b6c766b00527ac4616c766b00c3c001149c009c6c766b52527ac46c766b52c36439003254686520706172616d65746572206163636f756e742053484f554c442062652032302d62797465206164647265737365732e6175f06168164e656f2e53746f726167652e476574436f6e74657874056173736574617c652f0f6c766b51527ac46c766b51c36c766b00c3617c65530f6c766b53527ac46203006c766b53c3616c756600c56b58616c756654c56b6c766b00527ac4616c766b00c3c001209c009c6c766b52527ac46c766b52c3643d003654686520706172616d6574657220747849642053484f554c442062652033322d62797465207472616e73616374696f6e20686173682e6175f06168164e656f2e53746f726167652e476574436f6e7465787406726566756e64617c657a0e6c766b51527ac46c766b51c36c766b00c3617c659e0e6c766b53527ac46203006c766b53c3616c756656c56b6c766b00527ac4616c766b00c3c001209c009c6c766b53527ac46c766b53c3643d003654686520706172616d6574657220747849642053484f554c442062652033322d62797465207472616e73616374696f6e20686173682e6175f06168164e656f2e53746f726167652e476574436f6e74657874067478496e666f617c65cd0d6c766b51527ac46c766b51c36c766b00c3617c65f10d6c766b52527ac46c766b52c3c0009c6c766b54527ac46c766b54c3640e00006c766b55527ac4622c006c766b52c36168174e656f2e52756e74696d652e446573657269616c697a656c766b55527ac46203006c766b55c3616c756653c56b6c766b00527ac4616c766b00c361681a4e656f2e426c6f636b636861696e2e476574436f6e74726163746c766b51527ac46c766b51c36424006c766b51c36168164e656f2e436f6e74726163742e497350617961626c65620400516c766b52527ac46203006c766b52c3616c75660114c56b6161682953797374656d2e457865637574696f6e456e67696e652e476574536372697074436f6e7461696e65726c766b00527ac4006c766b51527ac46c766b00c361681d4e656f2e5472616e73616374696f6e2e4765745265666572656e6365736c766b52527ac4616c766b52c36c766b59527ac4006c766b5a527ac46210016c766b59c36c766b5ac3c36c766b5b527ac4616c766b5bc36168154e656f2e4f75747075742e476574417373657449646120e72d286979ee6cb1b7e65dfddfb2e384100b8d148e7758de42e4168b71792c609c6c766b5c527ac46c766b5cc36434006c766b51c376632400756c766b5bc36168184e656f2e4f75747075742e476574536372697074486173686c766b51527ac46c766b5bc36168184e656f2e4f75747075742e4765745363726970744861736861682d53797374656d2e457865637574696f6e456e67696e652e476574457865637574696e67536372697074486173689c6c766b5d527ac46c766b5dc3640e00006c766b5e527ac462dd02616c766b5ac351936c766b5a527ac46c766b5ac36c766b59c3c09f63e7fe6c766b00c36168174e656f2e5472616e73616374696f6e2e476574486173686165dafc00a06c766b5f527ac46c766b5fc3640e00006c766b5e527ac46280026c766b00c361681a4e656f2e5472616e73616374696f6e2e4765744f7574707574736c766b53527ac4006c766b54527ac4616c766b53c36c766b60527ac4006c766b0111527ac46203016c766b60c36c766b0111c3c36c766b0112527ac4616c766b0112c36168184e656f2e4f75747075742e4765745363726970744861736861682d53797374656d2e457865637574696f6e456e67696e652e476574457865637574696e6753637269707448617368907c907c9e6347006c766b0112c36168154e656f2e4f75747075742e476574417373657449646120e72d286979ee6cb1b7e65dfddfb2e384100b8d148e7758de42e4168b71792c609c620400006c766b0113527ac46c766b0113c3642e00616c766b54c36c766b0112c36168134e656f2e4f75747075742e47657456616c7565936c766b54527ac461616c766b0111c351936c766b0111527ac46c766b0111c36c766b60c3c09f63f3fe6168164e656f2e53746f726167652e476574436f6e7465787408636f6e7472616374617c658b096c766b55527ac46c766b55c30b746f74616c537570706c79617c65030a6c766b56527ac46c766b56c36c766b54c3936c766b56527ac46c766b55c30b746f74616c537570706c796c766b56c361527265290a616168164e656f2e53746f726167652e476574436f6e74657874056173736574617c6514096c766b57527ac46c766b57c36c766b51c3617c6538096c766b58527ac46c766b57c36c766b51c36c766b58c36c766b54c39361527265260a61006c766b51c36c766b54c36152726596046161006c766b51c36c766b54c3615272087472616e7366657254c168124e656f2e52756e74696d652e4e6f7469667961516c766b5e527ac46203006c766b5ec3616c756600c56b084e45503520474153616c75660111c56b6c766b00527ac4616c766b00c3c001149c009c6c766b59527ac46c766b59c36436002f54686520706172616d657465722066726f6d2053484f554c442062652032302d62797465206164647265737365732e6175f061682953797374656d2e457865637574696f6e456e67696e652e476574536372697074436f6e7461696e65726c766b51527ac46c766b51c361681a4e656f2e5472616e73616374696f6e2e4765744f75747075747300c36c766b52527ac46c766b52c36168154e656f2e4f75747075742e476574417373657449646120e72d286979ee6cb1b7e65dfddfb2e384100b8d148e7758de42e4168b71792c609e6c766b5a527ac46c766b5ac3640e00006c766b5b527ac46228036c766b52c36168184e656f2e4f75747075742e4765745363726970744861736861682d53797374656d2e457865637574696f6e456e67696e652e476574457865637574696e67536372697074486173689e6c766b5c527ac46c766b5cc3640e00006c766b5b527ac462bd026168164e656f2e53746f726167652e476574436f6e7465787406726566756e64617c65d5066c766b53527ac46c766b53c36c766b51c36168174e656f2e5472616e73616374696f6e2e47657448617368617c65df06c000a06c766b5d527ac46c766b5dc3640e00006c766b5b527ac4624b026c766b00c36168184e656f2e52756e74696d652e436865636b5769746e657373009c6c766b5e527ac46c766b5ec3640e00006c766b5b527ac4620f026168164e656f2e53746f726167652e476574436f6e74657874056173736574617c6528066c766b54527ac46c766b54c36c766b00c3617c654c066c766b55527ac46c766b52c36168134e656f2e4f75747075742e47657456616c75656c766b56527ac46c766b55c36c766b56c39f6c766b5f527ac46c766b5fc3640e00006c766b5b527ac46287016c766b55c36c766b56c39c6c766b60527ac46c766b60c36416006c766b54c36c766b00c3617c653f0761621f006c766b54c36c766b00c36c766b55c36c766b56c39461527265c606616c766b53c36c766b51c36168174e656f2e5472616e73616374696f6e2e476574486173686c766b00c3615272654007616168164e656f2e53746f726167652e476574436f6e7465787408636f6e7472616374617c6524056c766b57527ac46c766b57c30b746f74616c537570706c79617c659c056c766b58527ac46c766b58c36c766b56c3946c766b58527ac46c766b57c30b746f74616c537570706c796c766b58c361527265c205616c766b00c3006c766b56c3615272658c0061616c766b00c3006c766b56c3615272087472616e7366657254c168124e656f2e52756e74696d652e4e6f7469667961616c766b51c36168174e656f2e5472616e73616374696f6e2e476574486173686c766b00c3617c06726566756e6453c168124e656f2e52756e74696d652e4e6f7469667961516c766b5b527ac46203006c766b5bc3616c756656c56b6c766b00527ac46c766b51527ac46c766b52527ac46161682953797374656d2e457865637574696f6e456e67696e652e476574536372697074436f6e7461696e65726168174e656f2e5472616e73616374696f6e2e476574486173686c766b53527ac46153c5766c766b00c3007cc4766c766b51c3517cc4766c766b52c3527cc46c766b54527ac46168164e656f2e53746f726167652e476574436f6e74657874067478496e666f617c6587036c766b55527ac46c766b55c36c766b53c36c766b54c36168154e656f2e52756e74696d652e53657269616c697a6561527265470561616c756600c56b0443474153616c756600c56b1c7b224e45502d35222c20224e45502d37222c20224e45502d3130227d616c756652c56b616168164e656f2e53746f726167652e476574436f6e7465787408636f6e7472616374617c65f3026c766b00527ac46c766b00c30b746f74616c537570706c79617c656b036c766b51527ac46203006c766b51c3616c756653c56b6c766b00527ac46c766b51527ac46c766b52527ac451616c75665fc56b6c766b00527ac46c766b51527ac46c766b52527ac46c766b53527ac4616c766b00c3c00114907c907c9e6311006c766b51c3c001149c009c620400516c766b57527ac46c766b57c3643e003754686520706172616d65746572732066726f6d20616e6420746f2053484f554c442062652032302d62797465206164647265737365732e6175f06c766b52c300a16c766b58527ac46c766b58c36433002c54686520706172616d6574657220616d6f756e74204d5553542062652067726561746572207468616e20302e6175f06c766b51c3616575f4009c6c766b59527ac46c766b59c3640e00006c766b5a527ac462a9016c766b00c36168184e656f2e52756e74696d652e436865636b5769746e6573736311006c766b00c36c766b53c39e620400006c766b5b527ac46c766b5bc3640e00006c766b5a527ac4625d016168164e656f2e53746f726167652e476574436f6e74657874056173736574617c6542016c766b54527ac46c766b54c36c766b00c3617c6566016c766b55527ac46c766b55c36c766b52c39f6c766b5c527ac46c766b5cc3640e00006c766b5a527ac462f7006c766b00c36c766b51c39c6c766b5d527ac46c766b5dc3640e00516c766b5a527ac462d2006c766b55c36c766b52c39c6c766b5e527ac46c766b5ec36416006c766b54c36c766b00c3617c65560261621f006c766b54c36c766b00c36c766b55c36c766b52c39461527265dd01616c766b54c36c766b51c3617c65bd006c766b56527ac46c766b54c36c766b51c36c766b56c36c766b52c39361527265ab01616c766b00c36c766b51c36c766b52c36152726517fc61616c766b00c36c766b51c36c766b52c3615272087472616e7366657254c168124e656f2e52756e74696d652e4e6f7469667961516c766b5a527ac46203006c766b5ac3616c756653c56b6c766b00527ac46c766b51527ac4616152c5766c766b00c3007cc4766c766b51c3517cc46c766b52527ac46203006c766b52c3616c756654c56b6c766b00527ac46c766b51527ac4616c766b00c351c301007e6c766b51c37e6c766b52527ac46c766b00c300c36c766b52c3617c680f4e656f2e53746f726167652e4765746c766b53527ac46203006c766b53c3616c756654c56b6c766b00527ac46c766b51527ac4616c766b00c351c301007e6c766b51c37e6c766b52527ac46c766b00c300c36c766b52c3617c680f4e656f2e53746f726167652e4765746c766b53527ac46203006c766b53c3616c756654c56b6c766b00527ac46c766b51527ac46c766b52527ac4616c766b00c351c301007e6c766b51c37e6c766b53527ac46c766b00c300c36c766b53c36c766b52c3615272680f4e656f2e53746f726167652e50757461616c756654c56b6c766b00527ac46c766b51527ac46c766b52527ac4616c766b00c351c301007e6c766b51c37e6c766b53527ac46c766b00c300c36c766b53c36c766b52c3615272680f4e656f2e53746f726167652e50757461616c756653c56b6c766b00527ac46c766b51527ac4616c766b00c351c301007e6c766b51c37e6c766b52527ac46c766b00c300c36c766b52c3617c68124e656f2e53746f726167652e44656c65746561616c756654c56b6c766b00527ac46c766b51527ac46c766b52527ac4616c766b00c351c301007e6c766b51c37e6c766b53527ac46c766b00c300c36c766b53c36c766b52c3615272680f4e656f2e53746f726167652e50757461616c7566"
            }
        ],
        "blockhash": "0x41590a481d67f2f52c2aaa6ca4942c17b1afc36e30cf417e7980011cd75ce905",
        "confirmations": 1,
        "blocktime": 1536907793
    }
}
```

refund 第二步的 application log:

refund 第二步为普通的合约交易，没有 application log.

### 技术细节

#### Verification 触发器部分代码

这部分代码在 refund 第一步和 refund 第二步的时候执行，执行成功后交易确认，执行失败后交易不确认。

执行逻辑为：

获取当前交易的所有 inputs 和 outputs，分析 inputs 是否包已被标记为 refund，如果有则认为是用户在执行 refund 第二步的操作，如果没有则认为用户在执行refund 第一步的操作。

refund 第二步的逻辑很简单，只能标记为 refund 的人才可以把钱取走。

refund 第一步的逻辑也不复杂，进行交易后 CGAS 合约里的钱不会变少。

```c#
var tx = ExecutionEngine.ScriptContainer as Transaction;
var inputs = tx.GetInputs();
var outputs = tx.GetOutputs();
```

这段代码是获取智能合约调用的交易，从而获得交易输入和交易输出，为后续的判断做准备。

那么如何判断 inputs 是否包已被标记为 refund 呢？

```c#
foreach (var input in inputs)
{
    if (input.PrevIndex == 0)//If UTXO n is 0, it is possible to be a marker UTXO
    {
        StorageMap refund = Storage.CurrentContext.CreateMap(nameof(refund));
        var refundMan = refund.Get(input.PrevHash);
        //If the input that is marked for refund
        if (refundMan.Length > 0)
        {
            //Only one input and one output is allowed in refund
            if (inputs.Length != 1 || outputs.Length != 1)
                return false;
            return outputs[0].ScriptHash.AsBigInteger() == refundMan.AsBigInteger();
        }
    }
}
```

首先对所有交易输入进行遍历，在 refund 第一步操作的这里约定了用户进行 refund 的时候将第 0 号交易输出进行标记。所以这里对 UTXO 的 prevIndex 进行判断，如果是 0 则有可能是被标记的 UTXO，然后进行下一步判断。接下来是从存储区里读取 UTXO 的 prevHash，如果获取到值，则就是标记为 refund 的 UTXO。

问：既然从存储区里读取 prevHash 是最终的判断标准，为什么还要对 prevIndex 进行判断呢？

答：存储区操作会花费较多手续费，所以将判断分为两级，先进行手续费低的判断，再进行手续费高的判断。

**refund 第二步的代码**

当从存储区中读取到后，用户就可以将这笔钱取走，但是不能将 CGAS 中其余的钱取走，所以这里对 inputs 和 outputs 的数量进行了限制，在 refund 操作中只允许一个 input 和一个 output。

```c#
if (inputs.Length != 1 || outputs.Length != 1)
    return false;
return outputs[0].ScriptHash.AsBigInteger() == refundMan.AsBigInteger();
```

最后一句的意思就是只允许这个 UTXO 的所有人，也就是将它标记为 refund 的人能把钱取走。但是只允许一个 input 和一个 output 的话有一个潜在的 Bug，就是如果打算支付手续费的话，只能通过减少 outputs 的金额来支付手续费，而无法通过添加 inputs 的方式来支付手续费，也就是说用户无法通过添加一个带 GAS 的 UTXO 来作为附加手续费。

如何改进呢？

```c#
var references = tx.GetReferences();
for (int i = 1; i < references.Length; i++)
{
    if (references[i].ScriptHash.AsBigInteger() == currentHash.AsBigInteger())
        return false;
}
return outputs[0].ScriptHash.AsBigInteger() == refundMan.AsBigInteger();
```

可能像上面的代码一样，检测 inputs 中只能有第一笔是从 CGAS 中取走的，其余的 UTXO 不能从 CGAS 取走。如上面的代码，这样就形成一个约定，要取走的 UTXO 只能作为第一个 inputs，如果用户附加的手续费作为第一个 inputs，要取走的 UTXO 作为第二个 inputs 就会失败。

当然也可以进行下面的改进：

```c#
var references = tx.GetReferences();
int count = 0;
for (int i = 1; i < references.Length; i++)
{
    if (references[i].ScriptHash.AsBigInteger() == currentHash.AsBigInteger())
        count++;
}
if(count > 1)
    return false;
return outputs[0].ScriptHash.AsBigInteger() == refundMan.AsBigInteger();
```

这样改后就解除了“要取走的 UTXO 只能作为第一个 inputs”这样的限制，但多加了些代码也会使手续费升高。总之需要在手续费和用户体验中找到一个平衡点。

只允许一个 input 和一个 output

**refund 第一步的代码**

当所有的 inputs 中都没有检测到标记为 refund 的时候，就认为用户在执行 refund 第一步的操作。

和第二步不同的是，refund 第一步是一个 InvocationTransaction，执行分为两步，第一步是通过 Verification 触发器执行的，允许一笔从 CGAS 地址到 CGAS 地址的转账，要求转账后 CGAS 地址的金额不能少。而且在转账的时候不能使用被标记为 refund 的 UTXO。第二步是通过 Application 触发器执行的，这是在交易确认之后，才执行，这里先讲 Verification 触发器部分。

```c#
var currentHash = ExecutionEngine.ExecutingScriptHash;

BigInteger inputAmount = 0;
foreach (var refe in tx.GetReferences())
{
    if (refe.AssetId.AsBigInteger() != AssetId.AsBigInteger())
        return false;
    if (refe.ScriptHash.AsBigInteger() == currentHash.AsBigInteger())
        inputAmount += refe.Value;
}

BigInteger outputAmount = 0;
foreach (var output in outputs)
{
    if (output.ScriptHash.AsBigInteger() == currentHash.AsBigInteger())
        outputAmount += output.Value;
}

return outputAmount == inputAmount;
```

代码逻辑也很简单，首先不允许 inputs 中包含非 GAS 资产，然后对来自 CGAS 地址的 inputs 进行求和，再对转到 CGAS 地址的 outputs 进行求和，比较输入总和和输出总和是否相等。

这段代码在 CGAS 中是可以附加手续费的，但是到 CNEO 的话，由于限制了不能包含非 NEO 资产，所以无法附加手续费，这是已经的 Bug，但目前影响不大。如何改进呢？

```c#
BigInteger inputAmount = 0;
foreach (var refe in tx.GetReferences())
{
    if (refe.AssetId.AsBigInteger() == AssetId.AsBigInteger() && refe.ScriptHash.AsBigInteger() == currentHash.AsBigInteger())
        inputAmount += refe.Value;
}

BigInteger outputAmount = 0;
foreach (var output in outputs)
{
    if (output.AssetId.AsBigInteger() == AssetId.AsBigInteger() && output.ScriptHash.AsBigInteger() == currentHash.AsBigInteger())
        outputAmount += output.Value;
}
return outputAmount == inputAmount;
```

如上面的代码，首先去掉了不允许包含其它资产的限制，然后进行判断：交易输入中的来自合约地址的指定的资产的数量和交易输出中的转到合约地址的指定的资产的数量相等。这样就可以避免合约中指定资产的流失。

在判断中不仅要判断资产数量，还要判断资产种类，否则就有可能发生以下的攻击：

```
交易输入                      交易输出

CGAS  100 GAS                CGAS  100 Token1
User1 100 Token1             User1 100 GAS  
```

其中 User1 是用户的地址，Token1 是其它某个不值钱的全局资产。

智能合约的安全性不亚于金融软件的安全性，在编写时需要考虑得很全面，才能避免出现漏洞。

#### Application 触发器部分代码

这块就很简单了，就是标准的智能合约的格式，通过 method 的不同来执行不同的方法。

```c#
if (Runtime.Trigger == TriggerType.Application)
{
    var callscript = ExecutionEngine.CallingScriptHash;

    if (method == "balanceOf") return BalanceOf((byte[])args[0]);

    if (method == "decimals") return Decimals();

    if (method == "getRefundTarget") return GetRefundTarget((byte[])args[0]);

    if (method == "getTxInfo") return GetTxInfo((byte[])args[0]);

    if (method == "mintTokens") return MintTokens();

    if (method == "name") return Name();

    if (method == "refund") return Refund((byte[])args[0]);

    if (method == "symbol") return Symbol();

    if (method == "supportedStandards") return SupportedStandards();

    if (method == "totalSupply") return TotalSupply();

    if (method == "transfer") return Transfer((byte[])args[0], (byte[])args[1], (BigInteger)args[2], callscript);
}
```

需要注意的是，ExecutionEngine.CallingScriptHash 该方法的意思是获取合约调用链的上一级，也就是调用 CGAS 的合约，该方法需要在一开始执行，如果是在 Transfer 方法里面执行，获取的值可能不是调用链上一级的 ScriptHash。

#### VerificationR 触发器部分代码

```c#
if (Runtime.Trigger == TriggerType.VerificationR) //Backward compatibility, refusing to accept other assets
{
    var currentHash = ExecutionEngine.ExecutingScriptHash;
    var tx = ExecutionEngine.ScriptContainer as Transaction;
    foreach (var output in tx.GetOutputs())
    {
        if (output.ScriptHash == currentHash && output.AssetId.AsBigInteger() != AssetId.AsBigInteger())
            return false;
    }
    return true;
}
```

这个触发器目前还没有实现，是对 NEP-7 的向后兼容，如果节点支持 NEP-7，它在 CGAS 收到转账的时候会进行验证，返回 false 代表拒绝接收这笔转账，返回 true 代表接收这笔转账。在什么情况下拒绝接受转账呢？就是用户转了一些奇奇怪怪的资产，因为用户如果误转了其它资产到 CGAS 地址，他是无法将其取出的，所以这段代码就是加以限制。但目前主网上还不支持 NEP-7，所以暂时不起作用。

#### MintTokens 部分代码

```c#
var tx = ExecutionEngine.ScriptContainer as Transaction;
byte[] sender = null;
var inputs = tx.GetReferences();
foreach (var input in inputs)
{
    if (input.AssetId.AsBigInteger() == AssetId.AsBigInteger())
        sender = sender ?? input.ScriptHash;
    if (input.ScriptHash.AsBigInteger() == ExecutionEngine.ExecutingScriptHash.AsBigInteger())
        return false;
}
```

这几行代码的作用是获取发起 MintTokens 的人，也就是投资者。但要求投资者不能是 CGAS 本身，否则就可以利用此漏洞进行攻击。

```c#
if (GetTxInfo(tx.Hash) != null)
    return false;
```

接下来这句也是防止黑客攻击的，和 MintTokens 结尾这一段代码配合使用。

```c#
SetTxInfo(null, sender, value);
```

因为正常来讲一笔 Invocation 交易会执行一遍 Main 方法，从 NEO-GUI 里调用的也是这样，但如果黑客手动构造了一笔交易，让其执行多次 Main 方法，然后都调用了 MintTokens，就会导致一笔投资，进行多次铸币操作。通过这样的方法可以避免这类攻击。在一次 MintTokens 方法执行结束后， 将交易 ID 写在存储区里，每次执行 MintTokens 的时候，如果发现存储区里有该交易 ID，则返回 False，将其认为非法的 MintTokens 操作。

```c#
var outputs = tx.GetOutputs();
ulong value = 0;
foreach (var output in outputs)
{
    if (output.ScriptHash == ExecutionEngine.ExecutingScriptHash &&
        output.AssetId.AsBigInteger() == AssetId.AsBigInteger())
    {
        value += (ulong)output.Value;
    }
}
```

接下来的代码是进行计算用户向 CGAS 合约转账了多少 GAS，这里对所有交易输出进行了遍历，如果转的地址是 CGAS 地址，并且转的资产是 GAS，则进行统计。

获取了用户总共向 CGAS 合约转了多少 GAS 之后，就要做两件事件:

１、修改 CGAS 的总量

```c#
StorageMap contract = Storage.CurrentContext.CreateMap(nameof(contract));
var totalSupply = contract.Get("totalSupply").AsBigInteger(); 
totalSupply += value;
contract.Put("totalSupply", totalSupply);
```

２、给用户分按兑换比例发 CGAS

```c#
StorageMap asset = Storage.CurrentContext.CreateMap(nameof(asset));
var amount = asset.Get(sender).AsBigInteger();
asset.Put(sender, amount + value);
```

最后触发转账的事件，通知客户端无中生有地给一个用户进行了转账，也就是分发资产。

```c#
Transferred(null, sender, value);
```

Transferred 的参数有 3 个，分别是 转账人、收款人、转账金额。在 MintTokens 中，转账人为 null，在 refund 第一步，收款人为 null。

用户如果想在 MintTokens 的时候附加一些手续费，也是可以的，代码中只检测转给 CGAS 合约的交易输出中的 GAS 部分，用户交易输入中包含的 GAS，以及找零的 GAS 程序是不进行统计的。

#### Refund 部分代码

回顾一下方法说明中的介绍：用户将 CGAS 提取，变成 GAS 总共分两步。第一步，发起一笔 InvocationTransaction 其中包含一笔从 CGAS 地址到 CGAS 地址的 GAS 转账（转账金额为用户想退回的 GAS 的数量），并调用 refund 方法（参数为退回者的 Script Hash）。合约调用成功后，将自动销毁与退回数量相等的 CGAS，并把该交易的第 0 号 output 标记为所属于该用户。第二步，用户构造一个交易将第一步标记过的 UTXO 作为交易输入，交易输出为用户自己的地址，从而将 GAS 从 CGAS 地址中取走。

那么 refund 方法这一部分的代码对应上面的哪一步呢？

显然，refund 是在 Main 方法中的 Application 触发器中调用的，所以只有 InvocationTransaction 才可能触发该方法。对应的就是第一步中的交易成功后，执行 refund 方法这一步。

在代码中，有两段代码共同配合完成 Refund 的第一步的操作，一段就是上文所说的 Verification 触发器部分代码，第二段就是 refund 方法这一部分的代码。

这段代码是在 InvocationTransaction 验证成功后，才执行的。

```c#
if (from.Length != 20)
    throw new InvalidOperationException("The parameter from SHOULD be 20-byte addresses.");
```

首先是对参数进行验证，这符合 NEP-5 规范。在转账的过程一直是从 CGAS 合约地址转到 CGAS 合约地址，不存在用户的地址，所以为了获得用户的地址，需要把用户的地址作为参数传进来。

```c#
var tx = ExecutionEngine.ScriptContainer as Transaction;
var preRefund = tx.GetOutputs()[0];
if (preRefund.AssetId.AsBigInteger() != AssetId.AsBigInteger()) return false;
```

然后验证了 Refund 的资产是否符合要求。

```c#
if (preRefund.ScriptHash.AsBigInteger() != ExecutionEngine.ExecutingScriptHash.AsBigInteger()) return false;
```

接下来我们打算把 index 为 0 的交易输出标记为 refund，所以先验证一下这个交易输出是否转到的是 CGAS 地址，而不是其它的地址。

```c#
StorageMap refund = Storage.CurrentContext.CreateMap(nameof(refund));
if (refund.Get(tx.Hash).Length > 0) return false; 
……
refund.Put(tx.Hash, from);
```

这一步是预防性编程，防止同一个 UTXO 被多次 refund，如果发生会让用户损失资产。

```c#
if (!Runtime.CheckWitness(from)) return false;
```

最后一步验证就是验证签名，这是进行权限验证的常用手段，如果黑客想 refund 其它人的资产，我把 from 填写为其它人的地址，到这一步验证签名就会失败。

```c#
StorageMap asset = Storage.CurrentContext.CreateMap(nameof(asset));
var fromAmount = asset.Get(from).AsBigInteger(); 
var preRefundValue = preRefund.Value;
if (fromAmount < preRefundValue)
    return false;
else if (fromAmount == preRefundValue)
    asset.Delete(from); 
else
    asset.Put(from, fromAmount - preRefundValue); 
```

验证好身份之后，就要对用户资产进行操作了。这里做的事情就是将用户的资产减少，为了避免产生负数，先对 refund 的金额和用户的余额进行了比较。然后修改用户资产。

有用户的资产减少了，那么 CGAS 的总量也会减少，所以还要对 totalSupply 进行修改，代码如下：

```c#
StorageMap contract = Storage.CurrentContext.CreateMap(nameof(contract));
var totalSupply = contract.Get("totalSupply").AsBigInteger(); 
totalSupply -= preRefundValue;
contract.Put("totalSupply", totalSupply);
```

```c#
SetTxInfo(from, null, preRefundValue);
Transferred(from, null, preRefundValue);
Refunded(tx.Hash, from);
```

最后记录下交易 ID，方便查询，触发 Transferrd 事件，方便区块链浏览器和客户端处理。然后记下这个 UTXO 是谁退回的，为 refund 第二步做准备。